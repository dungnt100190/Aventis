#region Header

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.3053
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#endregion

using System;
using System.Collections.Generic;
using System.Data;
using KiSS4.DB;

namespace KiSS4.Administration.ZH
{
    public class CtlPscdKorrekturPerson : KiSS4.Common.KissSearchUserControl
    {
        #region Fields

        private KiSS4.Gui.KissButton btnEintragen;
        private System.ComponentModel.IContainer components;
        private KiSS4.Gui.KissMemoEdit edtFrage;
        private KiSS4.Gui.KissCalcEdit edtID;
        private KiSS4.Gui.KissDateEdit edtTransferdatum;
        private KiSS4.Gui.KissLookUpEdit edtType;
        private KiSS4.Gui.KissLabel kissLabel1;
        private KiSS4.Gui.KissLabel kissLabel2;
        private KiSS4.Gui.KissLabel kissLabel3;
        private System.Windows.Forms.Panel pnlSet;
        private KiSS4.DB.SqlQuery qryPscdData;

        #endregion

        #region Constructors

        public CtlPscdKorrekturPerson()
        {
            this.InitializeComponent();
        }

        #endregion

        #region Windows Form Designer generated code

        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            this.components = new System.ComponentModel.Container();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(CtlPscdKorrekturPerson));
            this.edtFrage = new KiSS4.Gui.KissMemoEdit();
            this.pnlSet = new System.Windows.Forms.Panel();
            this.btnEintragen = new KiSS4.Gui.KissButton();
            this.edtTransferdatum = new KiSS4.Gui.KissDateEdit();
            this.kissLabel3 = new KiSS4.Gui.KissLabel();
            this.kissLabel1 = new KiSS4.Gui.KissLabel();
            this.kissLabel2 = new KiSS4.Gui.KissLabel();
            this.edtID = new KiSS4.Gui.KissCalcEdit();
            this.edtType = new KiSS4.Gui.KissLookUpEdit();
            this.qryPscdData = new KiSS4.DB.SqlQuery(this.components);
            this.tabControlSearch.SuspendLayout();
            this.tpgListe.SuspendLayout();
            this.tpgSuchen.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)(this.edtFrage.Properties)).BeginInit();
            this.pnlSet.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)(this.edtTransferdatum.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel1)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtID.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtType)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtType.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPscdData)).BeginInit();
            this.SuspendLayout();
            //
            // searchTitle
            //
            this.searchTitle.Size = new System.Drawing.Size(776, 24);
            //
            // tabControlSearch
            //
            this.tabControlSearch.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)));
            this.tabControlSearch.Dock = System.Windows.Forms.DockStyle.Fill;
            this.tabControlSearch.Location = new System.Drawing.Point(0, 0);
            this.tabControlSearch.Size = new System.Drawing.Size(800, 500);
            //
            // tpgListe
            //
            this.tpgListe.Controls.Add(this.pnlSet);
            this.tpgListe.Controls.Add(this.edtFrage);
            this.tpgListe.Size = new System.Drawing.Size(788, 462);
            this.tpgListe.Title = "Liste";
            //
            // tpgSuchen
            //
            this.tpgSuchen.Controls.Add(this.edtType);
            this.tpgSuchen.Controls.Add(this.edtID);
            this.tpgSuchen.Controls.Add(this.kissLabel2);
            this.tpgSuchen.Controls.Add(this.kissLabel1);
            this.tpgSuchen.Size = new System.Drawing.Size(788, 462);
            this.tpgSuchen.Title = "Suche";
            this.tpgSuchen.Controls.SetChildIndex(this.searchTitle, 0);
            this.tpgSuchen.Controls.SetChildIndex(this.kissLabel1, 0);
            this.tpgSuchen.Controls.SetChildIndex(this.kissLabel2, 0);
            this.tpgSuchen.Controls.SetChildIndex(this.edtID, 0);
            this.tpgSuchen.Controls.SetChildIndex(this.edtType, 0);
            //
            // edtFrage
            //
            this.edtFrage.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Left)
                        | System.Windows.Forms.AnchorStyles.Right)));
            this.edtFrage.EditMode = Kiss.Interfaces.UI.EditModeType.ReadOnly;
            this.edtFrage.EditValue = "{0} mit ID {1} ist nicht als übertragen markiert. Soll dies manuell eingetragen w" +
                "erden?";
            this.edtFrage.Location = new System.Drawing.Point(22, 27);
            this.edtFrage.Name = "edtFrage";
            this.edtFrage.Properties.Appearance.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.edtFrage.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtFrage.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtFrage.Properties.Appearance.Options.UseBackColor = true;
            this.edtFrage.Properties.Appearance.Options.UseBorderColor = true;
            this.edtFrage.Properties.Appearance.Options.UseFont = true;
            this.edtFrage.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtFrage.Properties.ReadOnly = true;
            this.edtFrage.Properties.ScrollBars = System.Windows.Forms.ScrollBars.None;
            this.edtFrage.Size = new System.Drawing.Size(644, 79);
            this.edtFrage.TabIndex = 1;
            //
            // pnlSet
            //
            this.pnlSet.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.pnlSet.Controls.Add(this.kissLabel3);
            this.pnlSet.Controls.Add(this.edtTransferdatum);
            this.pnlSet.Controls.Add(this.btnEintragen);
            this.pnlSet.Location = new System.Drawing.Point(672, 3);
            this.pnlSet.Name = "pnlSet";
            this.pnlSet.Size = new System.Drawing.Size(113, 108);
            this.pnlSet.TabIndex = 5;
            //
            // btnEintragen
            //
            this.btnEintragen.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.btnEintragen.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnEintragen.Location = new System.Drawing.Point(15, 59);
            this.btnEintragen.Name = "btnEintragen";
            this.btnEintragen.Size = new System.Drawing.Size(90, 24);
            this.btnEintragen.TabIndex = 2;
            this.btnEintragen.Text = "Ja";
            this.btnEintragen.UseCompatibleTextRendering = true;
            this.btnEintragen.UseVisualStyleBackColor = true;
            this.btnEintragen.Click += new System.EventHandler(this.btnEintragen_Click);
            //
            // edtTransferdatum
            //
            this.edtTransferdatum.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.edtTransferdatum.EditValue = null;
            this.edtTransferdatum.Location = new System.Drawing.Point(10, 29);
            this.edtTransferdatum.Name = "edtTransferdatum";
            this.edtTransferdatum.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.False;
            this.edtTransferdatum.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtTransferdatum.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtTransferdatum.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtTransferdatum.Properties.Appearance.Options.UseBackColor = true;
            this.edtTransferdatum.Properties.Appearance.Options.UseBorderColor = true;
            this.edtTransferdatum.Properties.Appearance.Options.UseFont = true;
            this.edtTransferdatum.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtTransferdatum.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtTransferdatum.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtTransferdatum.Properties.ShowToday = false;
            this.edtTransferdatum.Size = new System.Drawing.Size(100, 24);
            this.edtTransferdatum.TabIndex = 3;
            //
            // kissLabel3
            //
            this.kissLabel3.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.kissLabel3.Location = new System.Drawing.Point(10, 4);
            this.kissLabel3.Name = "kissLabel3";
            this.kissLabel3.Size = new System.Drawing.Size(100, 23);
            this.kissLabel3.TabIndex = 4;
            this.kissLabel3.Text = "Transferdatum";
            this.kissLabel3.UseCompatibleTextRendering = true;
            //
            // kissLabel1
            //
            this.kissLabel1.Location = new System.Drawing.Point(8, 49);
            this.kissLabel1.Name = "kissLabel1";
            this.kissLabel1.Size = new System.Drawing.Size(72, 24);
            this.kissLabel1.TabIndex = 1;
            this.kissLabel1.Text = "Art";
            this.kissLabel1.UseCompatibleTextRendering = true;
            //
            // kissLabel2
            //
            this.kissLabel2.Location = new System.Drawing.Point(8, 79);
            this.kissLabel2.Name = "kissLabel2";
            this.kissLabel2.Size = new System.Drawing.Size(72, 24);
            this.kissLabel2.TabIndex = 1;
            this.kissLabel2.Text = "ID";
            this.kissLabel2.UseCompatibleTextRendering = true;
            //
            // edtID
            //
            this.edtID.Location = new System.Drawing.Point(86, 79);
            this.edtID.Name = "edtID";
            this.edtID.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.True;
            this.edtID.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtID.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtID.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtID.Properties.Appearance.Options.UseBackColor = true;
            this.edtID.Properties.Appearance.Options.UseBorderColor = true;
            this.edtID.Properties.Appearance.Options.UseFont = true;
            this.edtID.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtID.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtID.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtID.Size = new System.Drawing.Size(180, 24);
            this.edtID.TabIndex = 2;
            //
            // edtType
            //
            this.edtType.Location = new System.Drawing.Point(86, 49);
            this.edtType.Name = "edtType";
            this.edtType.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtType.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtType.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtType.Properties.Appearance.Options.UseBackColor = true;
            this.edtType.Properties.Appearance.Options.UseBorderColor = true;
            this.edtType.Properties.Appearance.Options.UseFont = true;
            this.edtType.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtType.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtType.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtType.Properties.Columns.AddRange(new DevExpress.XtraEditors.Controls.LookUpColumnInfo[] {
                        new DevExpress.XtraEditors.Controls.LookUpColumnInfo("Text")});
            this.edtType.Properties.DisplayMember = "Text";
            this.edtType.Properties.NullText = "";
            this.edtType.Properties.ShowFooter = false;
            this.edtType.Properties.ShowHeader = false;
            this.edtType.Properties.ValueMember = "Code";
            this.edtType.Size = new System.Drawing.Size(180, 24);
            this.edtType.TabIndex = 3;
            //
            // qryPscdData
            //
            this.qryPscdData.HostControl = this;
            this.qryPscdData.SelectStatement = resources.GetString("qryPscdData.SelectStatement");
            //
            // CtlPscdKorrekturPerson
            //
            this.ActiveSQLQuery = this.qryPscdData;
            this.Name = "CtlPscdKorrekturPerson";
            this.Load += new System.EventHandler(this.CtlPscdKorrekturPerson_Load);
            this.tabControlSearch.ResumeLayout(false);
            this.tpgListe.ResumeLayout(false);
            this.tpgSuchen.ResumeLayout(false);
            ((System.ComponentModel.ISupportInitialize)(this.edtFrage.Properties)).EndInit();
            this.pnlSet.ResumeLayout(false);
            ((System.ComponentModel.ISupportInitialize)(this.edtTransferdatum.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel1)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtID.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtType.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtType)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPscdData)).EndInit();
            this.ResumeLayout(false);
        }

        #endregion

        #region Dispose

        /// <summary>
        /// Clean up any resources being used.
        /// </summary>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                if ((components != null))
                {
                    components.Dispose();
                }
            }
            base.Dispose(disposing);
        }

        #endregion

        #region Public Methods

        public override void OnSearch()
        {
            pnlSet.Visible = false;

            DBUtil.CheckNotNullField(edtType, "Typ");
            DBUtil.CheckNotNullField(edtID, "ID");

            base.OnSearch();

            DataRow contextInfo = qryPscdData.DataSet.Tables[1].Rows[0];
            if( qryPscdData.Count == 0 )
            {
                pnlSet.Visible = false;
                edtFrage.Text = string.Format("Es existiert kein(e) {0} mit ID {1}", contextInfo["Typ"], contextInfo["ID"]);
            }
            else if( DBUtil.IsEmpty(qryPscdData["TransferDatum"]) )
            {
                pnlSet.Visible = true;
                edtFrage.Text = string.Format("{0} mit ID {1} ist nicht als übertragen markiert. Soll dies manuell eingetragen werden?", contextInfo["Typ"], contextInfo["ID"]);
                edtTransferdatum.EditValue = DateTime.Today;
            }
            else
            {
                pnlSet.Visible = false;
                edtFrage.Text = string.Format("{0} mit ID {1} wurde am {2} übertragen", contextInfo["Typ"], contextInfo["ID"], qryPscdData["TransferDatum"]);
            }
        }

        #endregion

        #region Private Methods

        private void CtlPscdKorrekturPerson_Load(object sender, System.EventArgs e)
        {
            edtType.Properties.DataSource = DBUtil.OpenSQL(@"
            DECLARE @tmp TABLE
            (
              Code   int,
              [Text] varchar(30)
            )

            INSERT INTO @tmp
            VALUES (1,'Person')
            INSERT INTO @tmp
            VALUES (2,'Institution')
            INSERT INTO @tmp
            VALUES (3,'Nettobeleg')
            INSERT INTO @tmp
            VALUES (4,'Bruttobeleg')

            SELECT Code, [Text]
            FROM @tmp");

            tabControlSearch.SelectedTabIndex = 1;
        }

        private void btnEintragen_Click(object sender, System.EventArgs e)
        {
            DataRow contextInfo = qryPscdData.DataSet.Tables[1].Rows[0];
            int type = (int)contextInfo["TypCode"];
            string sql;
            List<object> parameters = new List<object>();

            if( type == 1 ) //Person
            {
                sql = @"INSERT INTO PscdSentBaPerson
                        SELECT BaPersonID, BaPersonTS-1, {1}
                        FROM BaPerson
                        WHERE BaPersonID = {0}";
            }
            else if( type == 2 ) //Institution
            {
                sql = @"INSERT INTO PscdSentBaInstitution
                        SELECT BaInstitutionID, BaInstitutionTS-1, {1}
                        FROM BaInstitution
                        WHERE BaInstitutionID = {0}";
            }
            else if( type == 3 ) //Nettobeleg
            {
                sql = @"UPDATE KbBuchung
                        SET KbBuchungStatusCode = 3 /*Zahlauftrag erstellt*/,
                            TransferDatum = {1}
                        WHERE BelegNr = {0} AND KbBuchungStatusCode IN (2,5,16)";
            }
            else if( type == 4 ) //Bruttobeleg
            {
                sql = @"
                    DECLARE @KbBuchungID int, @KbBuchungBruttoID int

                    SELECT @KbBuchungID = KBU.KbBuchungID, @KbBuchungBruttoID = KBB.KbBuchungBruttoID
                    FROM KbBuchungBrutto KBB
                      INNER JOIN KbBuchungBruttoPerson KBP ON KBP.KbBuchungBruttoID = KBB.KbBuchungBruttoID
                      INNER JOIN KbBuchungKostenart    KBK ON KBK.BgPositionID      = KBP.BgPositionID
                      INNER JOIN KbBuchung             KBU ON KBU.KbBuchungID       = KBK.KbBuchungID
                    WHERE KBB.BelegNr = {0} AND KBB.KbBuchungStatusCode IN (2,5,16)

                    UPDATE KbBuchungBrutto
                    SET KbBuchungStatusCode = 3 /*Zahlauftrag erstellt*/,
                        TransferDatum = {1}
                    WHERE KbBuchungBruttoID = @KbBuchungBruttoID

                    UPDATE KbBuchung
                    SET KbBuchungStatusCode = 3 /*Zahlauftrag erstellt*/,
                        TransferDatum = {1}
                    WHERE KbBuchungID = @KbBuchungID";
            }
            else
            {
                KissMsg.ShowError("CtlPscdKorrekturPerson", "UnknownType", "Unbekannter Typ");
                return;
            }

            if( !string.IsNullOrEmpty(sql) )
            {
                try
                {
                    int rowsAffected = DBUtil.ExecSQLThrowingException(sql, contextInfo["ID"], edtTransferdatum.EditValue);
                    KissMsg.ShowInfo("CtlPscdKorrekturPerson", "RowsAffected", "{0} rows affected", 0, 0, rowsAffected);
                    this.OnSearch();

                }
                catch(KissCancelException ex)
                {
                    ex.ShowMessage();
                }
                catch(Exception ex)
                {
                    KissMsg.ShowError("CtlPscdKorrekturPerson", "SQLFehler", ex.Message);
                }
            }
        }

        #endregion
    }
}