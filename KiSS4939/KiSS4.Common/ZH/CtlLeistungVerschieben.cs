#region Header

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.832
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#endregion

using System;
using KiSS4.DB;
using KiSS4.Gui;

namespace KiSS4.Common.ZH
{
    public class CtlLeistungVerschieben : KiSS4.Gui.KissUserControl
    {
        #region Fields

        private KiSS4.Gui.KissButton btnVerschieben;
        private KiSS4.Gui.KissLookUpEdit edtLeistung;
        private KiSS4.Gui.KissButtonEdit edtQuellfall;
        private KiSS4.Gui.KissButtonEdit edtZielfall;
        private KiSS4.Gui.KissLabel lblQuellLeistung;
        private KiSS4.Gui.KissLabel lblQuellfall;
        private KiSS4.Gui.KissLabel lblZielfall;

        #endregion

        #region Constructors

        public CtlLeistungVerschieben()
        {
            this.InitializeComponent();
        }

        #endregion

        #region Windows Form Designer generated code

        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            DevExpress.Utils.SerializableAppearanceObject serializableAppearanceObject1 = new DevExpress.Utils.SerializableAppearanceObject();
            this.edtQuellfall = new KiSS4.Gui.KissButtonEdit();
            this.lblQuellfall = new KiSS4.Gui.KissLabel();
            this.edtZielfall = new KiSS4.Gui.KissButtonEdit();
            this.lblZielfall = new KiSS4.Gui.KissLabel();
            this.btnVerschieben = new KiSS4.Gui.KissButton();
            this.lblQuellLeistung = new KiSS4.Gui.KissLabel();
            this.edtLeistung = new KiSS4.Gui.KissLookUpEdit();
            ((System.ComponentModel.ISupportInitialize)(this.edtQuellfall.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblQuellfall)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtZielfall.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblZielfall)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblQuellLeistung)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtLeistung)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtLeistung.Properties)).BeginInit();
            this.SuspendLayout();
            //
            // edtQuellfall
            //
            this.edtQuellfall.Location = new System.Drawing.Point(71, 25);
            this.edtQuellfall.Name = "edtQuellfall";
            this.edtQuellfall.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtQuellfall.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtQuellfall.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtQuellfall.Properties.Appearance.Options.UseBackColor = true;
            this.edtQuellfall.Properties.Appearance.Options.UseBorderColor = true;
            this.edtQuellfall.Properties.Appearance.Options.UseFont = true;
            this.edtQuellfall.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtQuellfall.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton()});
            this.edtQuellfall.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtQuellfall.Size = new System.Drawing.Size(323, 24);
            this.edtQuellfall.TabIndex = 0;
            this.edtQuellfall.UserModifiedFld += new KiSS4.Gui.UserModifiedFldEventHandler(this.edtQuellfall_UserModifiedFld);
            //
            // lblQuellfall
            //
            this.lblQuellfall.Location = new System.Drawing.Point(13, 25);
            this.lblQuellfall.Name = "lblQuellfall";
            this.lblQuellfall.Size = new System.Drawing.Size(52, 24);
            this.lblQuellfall.TabIndex = 1;
            this.lblQuellfall.Text = "Quell-Fall";
            this.lblQuellfall.UseCompatibleTextRendering = true;
            //
            // edtZielfall
            //
            this.edtZielfall.Location = new System.Drawing.Point(573, 25);
            this.edtZielfall.Name = "edtZielfall";
            this.edtZielfall.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtZielfall.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtZielfall.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtZielfall.Properties.Appearance.Options.UseBackColor = true;
            this.edtZielfall.Properties.Appearance.Options.UseBorderColor = true;
            this.edtZielfall.Properties.Appearance.Options.UseFont = true;
            this.edtZielfall.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            serializableAppearanceObject1.BackColor = System.Drawing.Color.Bisque;
            serializableAppearanceObject1.Options.UseBackColor = true;
            this.edtZielfall.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Ellipsis, "", -1, true, true, false, DevExpress.Utils.HorzAlignment.Center, null, new DevExpress.Utils.KeyShortcut(System.Windows.Forms.Keys.None), serializableAppearanceObject1)});
            this.edtZielfall.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtZielfall.Size = new System.Drawing.Size(323, 24);
            this.edtZielfall.TabIndex = 2;
            this.edtZielfall.UserModifiedFld += new KiSS4.Gui.UserModifiedFldEventHandler(this.edtZielfall_UserModifiedFld);
            //
            // lblZielfall
            //
            this.lblZielfall.Location = new System.Drawing.Point(515, 25);
            this.lblZielfall.Name = "lblZielfall";
            this.lblZielfall.Size = new System.Drawing.Size(52, 24);
            this.lblZielfall.TabIndex = 3;
            this.lblZielfall.Text = "Ziel-Fall";
            this.lblZielfall.UseCompatibleTextRendering = true;
            //
            // btnVerschieben
            //
            this.btnVerschieben.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnVerschieben.IconID = 13;
            this.btnVerschieben.ImageAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.btnVerschieben.Location = new System.Drawing.Point(410, 47);
            this.btnVerschieben.Name = "btnVerschieben";
            this.btnVerschieben.Size = new System.Drawing.Size(99, 24);
            this.btnVerschieben.TabIndex = 4;
            this.btnVerschieben.Text = "Verschieben";
            this.btnVerschieben.TextAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.btnVerschieben.UseCompatibleTextRendering = true;
            this.btnVerschieben.UseVisualStyleBackColor = false;
            this.btnVerschieben.Click += new System.EventHandler(this.btnVerschieben_Click);
            //
            // lblQuellLeistung
            //
            this.lblQuellLeistung.Location = new System.Drawing.Point(13, 67);
            this.lblQuellLeistung.Name = "lblQuellLeistung";
            this.lblQuellLeistung.Size = new System.Drawing.Size(52, 24);
            this.lblQuellLeistung.TabIndex = 5;
            this.lblQuellLeistung.Text = "Leistung";
            this.lblQuellLeistung.UseCompatibleTextRendering = true;
            //
            // edtLeistung
            //
            this.edtLeistung.Location = new System.Drawing.Point(71, 67);
            this.edtLeistung.Name = "edtLeistung";
            this.edtLeistung.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtLeistung.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtLeistung.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtLeistung.Properties.Appearance.Options.UseBackColor = true;
            this.edtLeistung.Properties.Appearance.Options.UseBorderColor = true;
            this.edtLeistung.Properties.Appearance.Options.UseFont = true;
            this.edtLeistung.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtLeistung.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtLeistung.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtLeistung.Properties.Columns.AddRange(new DevExpress.XtraEditors.Controls.LookUpColumnInfo[] {
                        new DevExpress.XtraEditors.Controls.LookUpColumnInfo("Text")});
            this.edtLeistung.Properties.DisplayMember = "Text";
            this.edtLeistung.Properties.NullText = "";
            this.edtLeistung.Properties.ShowFooter = false;
            this.edtLeistung.Properties.ShowHeader = false;
            this.edtLeistung.Properties.ValueMember = "Code";
            this.edtLeistung.Size = new System.Drawing.Size(323, 24);
            this.edtLeistung.TabIndex = 7;
            //
            // CtlLeistungVerschieben
            //
            this.Controls.Add(this.edtLeistung);
            this.Controls.Add(this.lblQuellLeistung);
            this.Controls.Add(this.btnVerschieben);
            this.Controls.Add(this.lblZielfall);
            this.Controls.Add(this.edtZielfall);
            this.Controls.Add(this.lblQuellfall);
            this.Controls.Add(this.edtQuellfall);
            this.Name = "CtlLeistungVerschieben";
            this.Size = new System.Drawing.Size(908, 389);
            ((System.ComponentModel.ISupportInitialize)(this.edtQuellfall.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblQuellfall)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtZielfall.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblZielfall)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblQuellLeistung)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtLeistung.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtLeistung)).EndInit();
            this.ResumeLayout(false);
        }

        #endregion

        #region Private Methods

        private void FillLeistungen(object fallID)
        {
            if( fallID is int )
            {
                edtLeistung.Properties.DataSource = DBUtil.OpenSQL( @"SELECT Code = FaLeistungID, Text = XLC.Text + ', LT ' + PRS.Name + ', ' + PRS.Vorname + ', LV ' + USR.LastName + ', ' + USR.FirstName
                                                             FROM   FaLeistung     LEI
                                                               INNER JOIN XLOVCode XLC ON XLC.LOVName = 'FaProzess' AND XLC.Code = LEI.FaProzessCode
                                                               INNER JOIN BaPErson PRS ON PRS.BaPersonID = LEI.BaPersonID
                                                               INNER JOIN XUser    USR ON USR.UserID = LEI.UserID
                                                             WHERE FaFallID = {0}", fallID);
            }
            else
            {
                edtLeistung.Properties.DataSource = null;
            }
        }

        private void btnVerschieben_Click(object sender, System.EventArgs e)
        {
            if( DBUtil.IsEmpty(edtLeistung.EditValue) || DBUtil.IsEmpty(edtZielfall.LookupID) )
            {
                KissMsg.ShowError("CtlLeistungVerschieben", "FallLeer", "Bitte Quellleistung und Zielfall auswählen");
                return;
            }

            if( !KissMsg.ShowQuestion("CtlLeistungVerschieben", "PersonWirklichLöschen", "Wollen Sie die Leistung {0} in den Fall {1} verschieben?", 0, 0, true, edtLeistung.EditValue, edtZielfall.LookupID) )
                return;

            try
            {
                DBUtil.ExecSQLThrowingException(@"UPDATE FaLeistung
                                                  SET    FaFallID = {0}
                                                  WHERE  FaLeistungID = {1}", edtZielfall.LookupID, edtLeistung.EditValue);
                FillLeistungen( edtQuellfall.LookupID );
            }
            catch(Exception ex)
            {
                KissMsg.ShowError("CtlLeistungVerschieben", "LeistungNichtVerschiebbar", "Fehler beim Verschieben", ex);
            }
        }

        private void edtQuellfall_UserModifiedFld(object sender, KiSS4.Gui.UserModifiedFldEventArgs e)
        {
            string SearchString = edtQuellfall.EditValue.ToString().Replace("*", "%").Replace("?", "_").Replace(" ", "%");

            int? searchNr = null;
            int tmp;
            if( int.TryParse(edtQuellfall.EditValue.ToString(), out tmp) )
                searchNr = tmp;

            if (DBUtil.IsEmpty(SearchString))
            {
                if (e.ButtonClicked)
                {
                    SearchString = "%";
                }
                else
                {
                    edtQuellfall.EditValue = DBNull.Value;
                    edtQuellfall.LookupID  = DBNull.Value;
                }
            }

            KissLookupDialog dlg = new KissLookupDialog();
            e.Cancel = !dlg.SearchData(@"
              SELECT FallNr              = FAL.FaFallID,
                     Fallträger          = PRS.NameVorname,
                     Wohnsitz            = PRS.Wohnsitz,
                     DisplayText$        = 'Fall ' + CAST(FAL.FaFallID AS varchar) + ' - FT ' + PRS.NameVorname
              FROM   FaFall         FAL
                INNER JOIN vwPerson PRS ON PRS.BaPersonID = FAL.BaPersonID
              WHERE  PRS.NameVorname LIKE '%' + {0} + '%'
                OR FAL.FaFallID = {1}
              ORDER BY PRS.NameVorname",
              SearchString,
              e.ButtonClicked,searchNr,null,null);

            if (!e.Cancel)
            {
                    edtQuellfall.EditValue = dlg["DisplayText$"];
                edtQuellfall.LookupID  = dlg["FallNr"];
            }

            // Leistungen anzeigen
            FillLeistungen(edtQuellfall.LookupID);
        }

        private void edtZielfall_UserModifiedFld(object sender, KiSS4.Gui.UserModifiedFldEventArgs e)
        {
            string SearchString = edtZielfall.EditValue.ToString().Replace("*", "%").Replace("?", "_").Replace(" ", "%");

            int? searchNr = null;
            int tmp;
            if( int.TryParse(edtZielfall.EditValue.ToString(), out tmp) )
                searchNr = tmp;

            if (DBUtil.IsEmpty(SearchString))
            {
                if (e.ButtonClicked)
                {
                    SearchString = "%";
                }
                else
                {
                    edtZielfall.EditValue = DBNull.Value;
                    edtZielfall.LookupID  = DBNull.Value;
                }
            }

            KissLookupDialog dlg = new KissLookupDialog();
            e.Cancel = !dlg.SearchData(@"
              SELECT FallNr              = FAL.FaFallID,
                     Fallträger          = PRS.NameVorname,
                     Wohnsitz            = PRS.Wohnsitz,
                     DisplayText$        = 'Fall ' + CAST(FAL.FaFallID AS varchar) + ' - FT ' + PRS.NameVorname
              FROM   FaFall         FAL
                INNER JOIN vwPerson PRS ON PRS.BaPersonID = FAL.BaPersonID
              WHERE  PRS.NameVorname LIKE '%' + {0} + '%'
                OR FAL.FaFallID = {1}
              ORDER BY PRS.NameVorname",
              SearchString,
              e.ButtonClicked,searchNr,null,null);

            if (!e.Cancel)
            {
                    edtZielfall.EditValue = dlg["DisplayText$"];
                edtZielfall.LookupID  = dlg["FallNr"];
            }
        }

        #endregion
    }
}