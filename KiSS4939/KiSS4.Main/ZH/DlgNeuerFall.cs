#region Header

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.832
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#endregion

using System;
using System.Windows.Forms;
using KiSS4.DB;
using KiSS4.FAMOZ.VIS;
using KiSS4.Gui;

namespace KiSS4.Main.ZH
{
    public class DlgNeuerFall : KiSS4.Gui.KissDialog
    {
        #region Fields

        private int baPersonID = 0;
        private KiSS4.Gui.KissButton btnAbbrechen;
        private KiSS4.Gui.KissButton btnNeuerFall;
        private System.ComponentModel.IContainer components;
        private KiSS4.Main.ZH.CtlSuchePerson ctlSuchePerson;
        private KiSS4.Gui.KissCalcEdit edtFaFallID;
        private KiSS4.Gui.KissCheckEdit edtFAlimentwesen;
        private KiSS4.Gui.KissButtonEdit edtSAR;
        private int faFallID = 0;
        private KiSS4.Gui.KissLabel kissLabel26;
        private System.Windows.Forms.Panel panel1;
        private KiSS4.DB.SqlQuery qryFaFall;
        private KiSS4.DB.SqlQuery qryFaPhase;

        #endregion

        #region Constructors

        public DlgNeuerFall()
        {
            this.InitializeComponent();

            this.Activated += this_Activated;
            this.ActiveControl = ctlSuchePerson;
        }

        #endregion

        #region Windows Form Designer generated code

        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            this.components = new System.ComponentModel.Container();
            this.panel1 = new System.Windows.Forms.Panel();
            this.kissLabel26 = new KiSS4.Gui.KissLabel();
            this.edtSAR = new KiSS4.Gui.KissButtonEdit();
            this.btnAbbrechen = new KiSS4.Gui.KissButton();
            this.btnNeuerFall = new KiSS4.Gui.KissButton();
            this.edtFAlimentwesen = new KiSS4.Gui.KissCheckEdit();
            this.ctlSuchePerson = new KiSS4.Main.ZH.CtlSuchePerson();
            this.edtFaFallID = new KiSS4.Gui.KissCalcEdit();
            this.qryFaFall = new KiSS4.DB.SqlQuery(this.components);
            this.qryFaPhase = new KiSS4.DB.SqlQuery(this.components);
            this.panel1.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel26)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtSAR.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtFAlimentwesen.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtFaFallID.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryFaFall)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryFaPhase)).BeginInit();
            this.SuspendLayout();
            //
            // panel1
            //
            this.panel1.Controls.Add(this.edtFAlimentwesen);
            this.panel1.Controls.Add(this.btnNeuerFall);
            this.panel1.Controls.Add(this.btnAbbrechen);
            this.panel1.Controls.Add(this.edtSAR);
            this.panel1.Controls.Add(this.kissLabel26);
            this.panel1.Dock = System.Windows.Forms.DockStyle.Bottom;
            this.panel1.Location = new System.Drawing.Point(0, 587);
            this.panel1.Name = "panel1";
            this.panel1.Size = new System.Drawing.Size(964, 39);
            this.panel1.TabIndex = 0;
            //
            // kissLabel26
            //
            this.kissLabel26.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.kissLabel26.Location = new System.Drawing.Point(519, 0);
            this.kissLabel26.Name = "kissLabel26";
            this.kissLabel26.Size = new System.Drawing.Size(72, 24);
            this.kissLabel26.TabIndex = 3;
            this.kissLabel26.Text = "Mitarbeiter/in";
            this.kissLabel26.UseCompatibleTextRendering = true;
            //
            // edtSAR
            //
            this.edtSAR.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.edtSAR.Location = new System.Drawing.Point(606, 0);
            this.edtSAR.Name = "edtSAR";
            this.edtSAR.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtSAR.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtSAR.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtSAR.Properties.Appearance.Options.UseBackColor = true;
            this.edtSAR.Properties.Appearance.Options.UseBorderColor = true;
            this.edtSAR.Properties.Appearance.Options.UseFont = true;
            this.edtSAR.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtSAR.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton()});
            this.edtSAR.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtSAR.Properties.Name = "kissButtonEdit1.Properties";
            this.edtSAR.Size = new System.Drawing.Size(82, 24);
            this.edtSAR.TabIndex = 4;
            this.edtSAR.UserModifiedFld += new KiSS4.Gui.UserModifiedFldEventHandler(this.edtSAR_UserModifiedFld);
            //
            // btnAbbrechen
            //
            this.btnAbbrechen.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.btnAbbrechen.DialogResult = System.Windows.Forms.DialogResult.Cancel;
            this.btnAbbrechen.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnAbbrechen.Location = new System.Drawing.Point(844, 0);
            this.btnAbbrechen.Name = "btnAbbrechen";
            this.btnAbbrechen.Size = new System.Drawing.Size(90, 24);
            this.btnAbbrechen.TabIndex = 7;
            this.btnAbbrechen.Text = "Abbruch";
            this.btnAbbrechen.UseCompatibleTextRendering = true;
            this.btnAbbrechen.UseVisualStyleBackColor = false;
            //
            // btnNeuerFall
            //
            this.btnNeuerFall.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Right)));
            this.btnNeuerFall.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnNeuerFall.Location = new System.Drawing.Point(747, 0);
            this.btnNeuerFall.Name = "btnNeuerFall";
            this.btnNeuerFall.Size = new System.Drawing.Size(90, 24);
            this.btnNeuerFall.TabIndex = 8;
            this.btnNeuerFall.Text = "neuer Fall";
            this.btnNeuerFall.UseCompatibleTextRendering = true;
            this.btnNeuerFall.UseVisualStyleBackColor = false;
            this.btnNeuerFall.Click += new System.EventHandler(this.btnNeuerFall_Click);
            //
            // edtFAlimentwesen
            //
            this.edtFAlimentwesen.EditValue = false;
            this.edtFAlimentwesen.Location = new System.Drawing.Point(338, 3);
            this.edtFAlimentwesen.Name = "edtFAlimentwesen";
            this.edtFAlimentwesen.Properties.Appearance.BackColor = System.Drawing.Color.Transparent;
            this.edtFAlimentwesen.Properties.Appearance.Options.UseBackColor = true;
            this.edtFAlimentwesen.Properties.Caption = "Fallführung Alimentwesen";
            this.edtFAlimentwesen.Size = new System.Drawing.Size(152, 19);
            this.edtFAlimentwesen.TabIndex = 9;
            //
            // ctlSuchePerson
            //
            this.ctlSuchePerson.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.ctlSuchePerson.Dock = System.Windows.Forms.DockStyle.Fill;
            this.ctlSuchePerson.Location = new System.Drawing.Point(0, 0);
            this.ctlSuchePerson.Name = "ctlSuchePerson";
            this.ctlSuchePerson.Size = new System.Drawing.Size(964, 587);
            this.ctlSuchePerson.TabIndex = 1;
            //
            // edtFaFallID
            //
            this.edtFaFallID.DataMember = "FaFallID";
            this.edtFaFallID.DataSource = this.qryFaFall;
            this.edtFaFallID.Location = new System.Drawing.Point(51, 4);
            this.edtFaFallID.Name = "edtFaFallID";
            this.edtFaFallID.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.True;
            this.edtFaFallID.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtFaFallID.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtFaFallID.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtFaFallID.Properties.Appearance.Options.UseBackColor = true;
            this.edtFaFallID.Properties.Appearance.Options.UseBorderColor = true;
            this.edtFaFallID.Properties.Appearance.Options.UseFont = true;
            this.edtFaFallID.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtFaFallID.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
                        new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtFaFallID.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtFaFallID.Size = new System.Drawing.Size(100, 24);
            this.edtFaFallID.TabIndex = 2;
            this.edtFaFallID.Visible = false;
            //
            // qryFaFall
            //
            this.qryFaFall.CanDelete = true;
            this.qryFaFall.CanInsert = true;
            this.qryFaFall.CanUpdate = true;
            this.qryFaFall.TableName = "FaFall";
            //
            // qryFaPhase
            //
            this.qryFaPhase.CanDelete = true;
            this.qryFaPhase.CanInsert = true;
            this.qryFaPhase.CanUpdate = true;
            this.qryFaPhase.TableName = "FaPhase";
            //
            // DlgNeuerFall
            //
            this.ClientSize = new System.Drawing.Size(964, 626);
            this.Controls.Add(this.edtFaFallID);
            this.Controls.Add(this.ctlSuchePerson);
            this.Controls.Add(this.panel1);
            this.Name = "DlgNeuerFall";
            this.Text = "Neuer Fall";
            this.Load += new System.EventHandler(this.DlgNeuerFall_Load);
            this.panel1.ResumeLayout(false);
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel26)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtSAR.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtFAlimentwesen.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtFaFallID.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryFaFall)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryFaPhase)).EndInit();
            this.ResumeLayout(false);
        }

        #endregion

        #region Dispose

        /// <summary>
        /// Clean up any resources being used.
        /// </summary>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                if ((components != null))
                {
                    components.Dispose();
                }
            }
            base.Dispose(disposing);
        }

        #endregion

        #region Public Properties

        public int BaPersonID
        {
            get
            {
                return baPersonID;
            }
            set
            {
                baPersonID = value;
            }
        }

        #endregion

        #region Private Methods

        private void btnNeuerFall_Click(object sender, EventArgs e)
        {
            try
            {
                Cursor = Cursors.WaitCursor;

                try
                {
                    edtSAR.CheckPendingSearchValue();
                    if (DBUtil.IsEmpty(edtSAR.Tag))
                        throw new KissInfoException(KissMsg.GetMLMessage("DlgNeuerFall", "MitarbeiterLeer", "Das Feld 'Mitarbeiter/-in' darf nicht leer bleiben!", KissMsgCode.MsgInfo));
                }
                catch (KissCancelException ex)
                {
                    ex.ShowMessage();
                    return;
                }
                finally
                {
                    Cursor = Cursors.Default;
                }

                int? baPersonIDNillable;
                try
                {
                    Cursor = Cursors.WaitCursor;
                    baPersonIDNillable = ctlSuchePerson.GetPersonIDCreateIfNecessary(true);
                    if (!baPersonIDNillable.HasValue)
                    {
                        return;
                    }
                }
                catch (KissInfoException ex)
                {
                    ex.ShowMessage();
                    return;
                }
                catch (KissCancelException ex)
                {
                    ex.ShowMessage();
                    return;
                }
                catch (Exception ex)
                {
                    KissMsg.ShowError("DlgNeuerFall", "FehlerGetPerson", "Die Person konnte nicht eingefügt werden.", ex);
                    return;
                }
                finally
                {
                    Cursor = Cursors.Default;
                }

                //todo: "Klonen" der bisher gemeinsamen Adresse, falls vorher Mitglied in einem Haushalt

                baPersonID = baPersonIDNillable.Value;

                // Falls VIV-Fall => Lasse Benutzer noch die Massnahme selektieren (inkl. Prüfung, ob Massnahme nicht schon im KiSS geführt wird)
                DlgVISNeueMassnahme dlgVISNeueMassnahme = null;
                if (!DBUtil.IsEmpty(ctlSuchePerson.SelectedVISFallNr))
                {
                    //neue Leistungseinheit (Vormundschaftliches Mandat)
                    dlgVISNeueMassnahme = new DlgVISNeueMassnahme(faFallID, int.Parse(ctlSuchePerson.SelectedVISFallNr.ToString()), baPersonID, false);
                    dlgVISNeueMassnahme.ShowDialog();

                    if (dlgVISNeueMassnahme.DialogResult == DialogResult.Cancel)
                    {
                        return;
                    }
                }

                Cursor = Cursors.WaitCursor;
                Session.BeginTransaction();

                //neuen FaFall erzeugen
                qryFaFall.Fill("SELECT TOP 0 * FROM FaFall");
                qryFaFall.Insert();
                qryFaFall["BaPersonID"] = baPersonID;
                qryFaFall["UserID"] = edtSAR.Tag;
                qryFaFall["DatumVon"] = DateTime.Today;
                if (!qryFaFall.Post()) return;
                faFallID = (int)qryFaFall["FaFallID"];

                int FaProzessCode = edtFAlimentwesen.Checked ? 201 : 200;

                //neue Leistungseinheit (Fallführung)
                DBUtil.ExecSQL(@"INSERT INTO FaLeistung (FaFallID, ModulID, FaProzessCode, BaPersonID, UserID, DatumVon, Creator, Created, Modifier, Modified)
                                    VALUES ({0}, 2, {1}, {2}, {3}, GETDATE(), {4}, {5}, {4}, {5})",
                                        faFallID, FaProzessCode, baPersonID, edtSAR.Tag, DBUtil.GetDBRowCreatorModifier(), DateTime.Now);

                //Eintrag ins Fallverlaufsprotokoll
                DBUtil.ExecSQL(@"INSERT INTO dbo.FaJournal (FaFallID,FaLeistungID,BaPersonID,UserID,Text)
                                  VALUES ({0},@@identity,{1},{2},{3})",
                                      faFallID, baPersonID, Session.User.UserID, "Fallaufnahme" + (edtFAlimentwesen.Checked ? " Aliemntwesen" : ""));

                //Person als Beziehung zu Fall in FaFallPerson eintragen
                DBUtil.ExecSQL(@"INSERT INTO dbo.FaFallPerson (FaFallID, BaPersonID)
                                  VALUES ({0}, {1})", faFallID, baPersonID);

                // Commit des neuen Falls
                Session.Commit();

                // Erstelle noch die V-Leistung, falls nötig.
                if (dlgVISNeueMassnahme != null)
                {
                    dlgVISNeueMassnahme.CreateVLeistung(faFallID);
                }

                // Jump to new Fall
                FormController.OpenForm(
                    "FrmFall",
                    "Action",
                    "ShowFall",
                    "BaPersonID",
                    baPersonID,
                    "ModulCode",
                    ModulID.B);

                this.DialogResult = DialogResult.OK;
            }
            catch (Exception exp)
            {
                Session.Rollback();
                KissMsg.ShowError("DlgNeuerFall", "FehlerBeimErzeugen", "Beim Erzeugen des neuen Klientensystems ist ein Fehler aufgetreten.", exp);
            }
            finally
            {
                Cursor = Cursors.Default;
            }
        }

        private void DlgNeuerFall_Load(object sender, System.EventArgs e)
        {
            ProposeUser(edtSAR);
            bool modulAAktiv = (bool)DBUtil.ExecuteScalarSQLThrowingException(@"SELECT Licensed FROM XModul WHERE ModulID = {0}", ModulID.I);
            edtFAlimentwesen.Visible = false; // modulAAktiv;
            edtFAlimentwesen.Checked = false;
        }

        private void edtSAR_UserModifiedFld(object sender, KiSS4.Gui.UserModifiedFldEventArgs e)
        {
            string SearchString = edtSAR.EditValue.ToString().Replace("*", "%").Replace("?", "_").Replace(" ", "%");

            if (DBUtil.IsEmpty(SearchString))
            {
                if (e.ButtonClicked)
                {
                    SearchString = "%";
                }
                else
                {
                    edtSAR.EditValue = DBNull.Value;
                    edtSAR.Tag = DBNull.Value;
                    return;
                }
            }

            KissLookupDialog dlg = new KissLookupDialog();
            e.Cancel = !dlg.SearchData(@"
              select ID$              = USR.UserID,
                     [Kürzel]         = LogonName,
                     [Mitarbeiter/in] = LastName + isNull(', ' + FirstName,''),
                     [Org.Einheit]    = XOU.ItemName
              from   XUser USR
                 left join XOrgUnit_User OUU ON OUU.UserID = USR.UserID AND OUU.OrgUnitMemberCode = 2
                 left join XOrgUnit      XOU ON XOU.OrgUnitID = OUU.OrgUnitID
              where USR.LogonName like '%' + {0} + '%' order by [Kürzel]",
              SearchString,
              e.ButtonClicked, null, null, null);

            if (!e.Cancel)
            {
                edtSAR.EditValue = dlg[1];
                edtSAR.LookupID = dlg[0];
                edtSAR.Tag = dlg[0];
            }
        }

        private void ProposeUser(KissButtonEdit edt)
        {
            //eingeloggten User vorschlagen
            edt.EditValue = Session.User.LogonName;
            edt.Tag = Session.User.UserID;
        }

        private void this_Activated(object sender, System.EventArgs e)
        {
            ctlSuchePerson.Activate();
        }

        #endregion
    }
}