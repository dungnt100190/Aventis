#region Header

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.3053
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#endregion

using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using Kiss.Interfaces.UI;
using KiSS4.DB;
using KiSS4.Gui;

namespace KiSS4.Vormundschaft.ZH
{
    public class CtlKgPeriode : KiSS4.Gui.KissUserControl
    {
        #region Fields

        private int baPersonID = 0;
        private KiSS4.Gui.KissButton btnAbschluss;
        private KiSS4.Gui.KissButton btnAktiv;
        private KiSS4.Gui.KissButton btnSaldiVortragen;
        private KiSS4.Gui.KissCheckEdit chkPeriodenUeberschneidungZulassen;
        private DevExpress.XtraGrid.Columns.GridColumn colBis;
        private DevExpress.XtraGrid.Columns.GridColumn colDefinitiv;
        private DevExpress.XtraGrid.Columns.GridColumn colKontoZahlverkehr;
        private DevExpress.XtraGrid.Columns.GridColumn colStatus;
        private DevExpress.XtraGrid.Columns.GridColumn colVon;
        private System.ComponentModel.IContainer components;
        private KiSS4.Gui.KissTextEdit edtAdresse;
        private KiSS4.Gui.KissTextEdit edtBaPersonID;
        private KiSS4.Gui.KissLookUpEdit edtBaZahlungsweg;
        private KiSS4.Gui.KissButtonEdit edtMandant;
        private KiSS4.Gui.KissTextEdit edtMT;
        private KiSS4.Gui.KissDateEdit edtPeriodeBis;
        private KiSS4.Gui.KissDateEdit edtPeriodeVon;
        private int faLeistungID = 0;
        private KiSS4.Gui.KissGrid grdPeriode;
        private DevExpress.XtraGrid.Views.Grid.GridView grvPeriode;
        private KiSS4.Gui.KissLabel kissLabel2;
        private KiSS4.Gui.KissLabel kissLabel3;
        private KiSS4.Gui.KissLabel label1;
        private KiSS4.Gui.KissLabel label10;
        private KiSS4.Gui.KissLabel label40;
        private KiSS4.Gui.KissLabel lblBaZahlungsweg;
        private KiSS4.Gui.KissLabel lblPeriodeBis;
        private KiSS4.Gui.KissLabel lblPeriodeVon;
        private KiSS4.Gui.KissLabel lblTitel;
        private System.Windows.Forms.Panel panel1;
        private System.Windows.Forms.PictureBox picTitel;
        private KiSS4.DB.SqlQuery qryPeriode;
        private DataRowState SaveRowState;

        #endregion

        #region Constructors

        public CtlKgPeriode()
        {
            this.InitializeComponent();
        }

        #endregion

        #region Windows Form Designer generated code

        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            this.components = new System.ComponentModel.Container();
            DevExpress.Utils.SerializableAppearanceObject serializableAppearanceObject1 = new DevExpress.Utils.SerializableAppearanceObject();
            DevExpress.Utils.SerializableAppearanceObject serializableAppearanceObject4 = new DevExpress.Utils.SerializableAppearanceObject();
            DevExpress.Utils.SerializableAppearanceObject serializableAppearanceObject3 = new DevExpress.Utils.SerializableAppearanceObject();
            DevExpress.Utils.SerializableAppearanceObject serializableAppearanceObject2 = new DevExpress.Utils.SerializableAppearanceObject();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(CtlKgPeriode));
            this.edtMandant = new KiSS4.Gui.KissButtonEdit();
            this.grdPeriode = new KiSS4.Gui.KissGrid();
            this.qryPeriode = new KiSS4.DB.SqlQuery(this.components);
            this.grvPeriode = new DevExpress.XtraGrid.Views.Grid.GridView();
            this.colVon = new DevExpress.XtraGrid.Columns.GridColumn();
            this.colBis = new DevExpress.XtraGrid.Columns.GridColumn();
            this.colStatus = new DevExpress.XtraGrid.Columns.GridColumn();
            this.colDefinitiv = new DevExpress.XtraGrid.Columns.GridColumn();
            this.colKontoZahlverkehr = new DevExpress.XtraGrid.Columns.GridColumn();
            this.edtPeriodeVon = new KiSS4.Gui.KissDateEdit();
            this.edtPeriodeBis = new KiSS4.Gui.KissDateEdit();
            this.edtBaZahlungsweg = new KiSS4.Gui.KissLookUpEdit();
            this.btnAktiv = new KiSS4.Gui.KissButton();
            this.btnAbschluss = new KiSS4.Gui.KissButton();
            this.btnSaldiVortragen = new KiSS4.Gui.KissButton();
            this.kissLabel2 = new KiSS4.Gui.KissLabel();
            this.lblPeriodeVon = new KiSS4.Gui.KissLabel();
            this.lblPeriodeBis = new KiSS4.Gui.KissLabel();
            this.panel1 = new System.Windows.Forms.Panel();
            this.picTitel = new System.Windows.Forms.PictureBox();
            this.lblTitel = new KiSS4.Gui.KissLabel();
            this.label40 = new KiSS4.Gui.KissLabel();
            this.edtAdresse = new KiSS4.Gui.KissTextEdit();
            this.edtBaPersonID = new KiSS4.Gui.KissTextEdit();
            this.edtMT = new KiSS4.Gui.KissTextEdit();
            this.label10 = new KiSS4.Gui.KissLabel();
            this.label1 = new KiSS4.Gui.KissLabel();
            this.kissLabel3 = new KiSS4.Gui.KissLabel();
            this.lblBaZahlungsweg = new KiSS4.Gui.KissLabel();
            this.chkPeriodenUeberschneidungZulassen = new KiSS4.Gui.KissCheckEdit();
            ((System.ComponentModel.ISupportInitialize)(this.edtMandant.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.grdPeriode)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPeriode)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.grvPeriode)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtPeriodeVon.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtPeriodeBis.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaZahlungsweg)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaZahlungsweg.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblPeriodeVon)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblPeriodeBis)).BeginInit();
            this.panel1.SuspendLayout();
            ((System.ComponentModel.ISupportInitialize)(this.picTitel)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblTitel)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.label40)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtAdresse.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaPersonID.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtMT.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.label10)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.label1)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblBaZahlungsweg)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.chkPeriodenUeberschneidungZulassen.Properties)).BeginInit();
            this.SuspendLayout();
            //
            // edtMandant
            //
            this.edtMandant.Location = new System.Drawing.Point(113, 61);
            this.edtMandant.Name = "edtMandant";
            this.edtMandant.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtMandant.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtMandant.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtMandant.Properties.Appearance.Options.UseBackColor = true;
            this.edtMandant.Properties.Appearance.Options.UseBorderColor = true;
            this.edtMandant.Properties.Appearance.Options.UseFont = true;
            this.edtMandant.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            serializableAppearanceObject1.BackColor = System.Drawing.Color.Bisque;
            serializableAppearanceObject1.Options.UseBackColor = true;
            this.edtMandant.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
            new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Ellipsis, "", -1, true, true, false, DevExpress.Utils.HorzAlignment.Center, null, new DevExpress.Utils.KeyShortcut(System.Windows.Forms.Keys.None), serializableAppearanceObject1)});
            this.edtMandant.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtMandant.Properties.Name = "editMandant.Properties";
            this.edtMandant.SearchStringWhitelist = new string[] {
        ".",
        "*",
        "%"};
            this.edtMandant.Size = new System.Drawing.Size(242, 24);
            this.edtMandant.TabIndex = 0;
            this.edtMandant.UserModifiedFld += new KiSS4.Gui.UserModifiedFldEventHandler(this.edtMandant_UserModifiedFld);
            //
            // grdPeriode
            //
            this.grdPeriode.Anchor = ((System.Windows.Forms.AnchorStyles)(((System.Windows.Forms.AnchorStyles.Top | System.Windows.Forms.AnchorStyles.Bottom)
            | System.Windows.Forms.AnchorStyles.Left)));
            this.grdPeriode.DataSource = this.qryPeriode;
            //
            //
            //
            this.grdPeriode.EmbeddedNavigator.Name = "gridPeriode.EmbeddedNavigator";
            this.grdPeriode.GridStyle = KiSS4.Gui.GridStyleType.ReadOnly;
            this.grdPeriode.Location = new System.Drawing.Point(5, 177);
            this.grdPeriode.MainView = this.grvPeriode;
            this.grdPeriode.Name = "grdPeriode";
            this.grdPeriode.Size = new System.Drawing.Size(715, 163);
            this.grdPeriode.TabIndex = 1;
            this.grdPeriode.ViewCollection.AddRange(new DevExpress.XtraGrid.Views.Base.BaseView[] {
            this.grvPeriode});
            //
            // qryPeriode
            //
            this.qryPeriode.CanDelete = true;
            this.qryPeriode.CanInsert = true;
            this.qryPeriode.CanUpdate = true;
            this.qryPeriode.HostControl = this;
            this.qryPeriode.SelectStatement = resources.GetString("qryPeriode.SelectStatement");
            this.qryPeriode.TableName = "KgPeriode";
            this.qryPeriode.AfterDelete += new System.EventHandler(this.qryPeriode_AfterDelete);
            this.qryPeriode.AfterInsert += new System.EventHandler(this.qryPeriode_AfterInsert);
            this.qryPeriode.AfterPost += new System.EventHandler(this.qryPeriode_AfterPost);
            this.qryPeriode.BeforeDelete += new System.EventHandler(this.qryPeriode_BeforeDelete);
            this.qryPeriode.BeforeInsert += new System.EventHandler(this.qryPeriode_BeforeInsert);
            this.qryPeriode.BeforePost += new System.EventHandler(this.qryPeriode_BeforePost);
            this.qryPeriode.PositionChanged += new System.EventHandler(this.qryPeriode_PositionChanged);
            //
            // grvPeriode
            //
            this.grvPeriode.Appearance.Empty.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.grvPeriode.Appearance.Empty.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.Empty.Options.UseBackColor = true;
            this.grvPeriode.Appearance.Empty.Options.UseFont = true;
            this.grvPeriode.Appearance.EvenRow.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(236)))), ((int)(((byte)(227)))), ((int)(((byte)(215)))));
            this.grvPeriode.Appearance.EvenRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.EvenRow.Options.UseBackColor = true;
            this.grvPeriode.Appearance.EvenRow.Options.UseFont = true;
            this.grvPeriode.Appearance.FocusedCell.BackColor = System.Drawing.SystemColors.Highlight;
            this.grvPeriode.Appearance.FocusedCell.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.FocusedCell.ForeColor = System.Drawing.Color.White;
            this.grvPeriode.Appearance.FocusedCell.Options.UseBackColor = true;
            this.grvPeriode.Appearance.FocusedCell.Options.UseFont = true;
            this.grvPeriode.Appearance.FocusedCell.Options.UseForeColor = true;
            this.grvPeriode.Appearance.FocusedRow.BackColor = System.Drawing.SystemColors.Highlight;
            this.grvPeriode.Appearance.FocusedRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.FocusedRow.ForeColor = System.Drawing.Color.White;
            this.grvPeriode.Appearance.FocusedRow.Options.UseBackColor = true;
            this.grvPeriode.Appearance.FocusedRow.Options.UseFont = true;
            this.grvPeriode.Appearance.FocusedRow.Options.UseForeColor = true;
            this.grvPeriode.Appearance.GroupPanel.BackColor = System.Drawing.Color.PeachPuff;
            this.grvPeriode.Appearance.GroupPanel.Options.UseBackColor = true;
            this.grvPeriode.Appearance.GroupRow.BackColor = System.Drawing.Color.PeachPuff;
            this.grvPeriode.Appearance.GroupRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel, ((byte)(0)));
            this.grvPeriode.Appearance.GroupRow.ForeColor = System.Drawing.SystemColors.WindowText;
            this.grvPeriode.Appearance.GroupRow.Options.UseBackColor = true;
            this.grvPeriode.Appearance.GroupRow.Options.UseFont = true;
            this.grvPeriode.Appearance.GroupRow.Options.UseForeColor = true;
            this.grvPeriode.Appearance.HeaderPanel.BackColor = System.Drawing.Color.Tan;
            this.grvPeriode.Appearance.HeaderPanel.BorderColor = System.Drawing.Color.Tan;
            this.grvPeriode.Appearance.HeaderPanel.Font = new System.Drawing.Font("Arial", 11F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel, ((byte)(0)));
            this.grvPeriode.Appearance.HeaderPanel.Options.UseBackColor = true;
            this.grvPeriode.Appearance.HeaderPanel.Options.UseBorderColor = true;
            this.grvPeriode.Appearance.HeaderPanel.Options.UseFont = true;
            this.grvPeriode.Appearance.HideSelectionRow.BackColor = System.Drawing.Color.PowderBlue;
            this.grvPeriode.Appearance.HideSelectionRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.HideSelectionRow.ForeColor = System.Drawing.SystemColors.WindowText;
            this.grvPeriode.Appearance.HideSelectionRow.Options.UseBackColor = true;
            this.grvPeriode.Appearance.HideSelectionRow.Options.UseFont = true;
            this.grvPeriode.Appearance.HideSelectionRow.Options.UseForeColor = true;
            this.grvPeriode.Appearance.HorzLine.BackColor = System.Drawing.Color.Silver;
            this.grvPeriode.Appearance.HorzLine.Options.UseBackColor = true;
            this.grvPeriode.Appearance.OddRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.OddRow.Options.UseFont = true;
            this.grvPeriode.Appearance.Row.BackColor = System.Drawing.Color.BlanchedAlmond;
            this.grvPeriode.Appearance.Row.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.Row.Options.UseBackColor = true;
            this.grvPeriode.Appearance.Row.Options.UseFont = true;
            this.grvPeriode.Appearance.SelectedRow.BackColor = System.Drawing.Color.AliceBlue;
            this.grvPeriode.Appearance.SelectedRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.grvPeriode.Appearance.SelectedRow.ForeColor = System.Drawing.Color.Black;
            this.grvPeriode.Appearance.SelectedRow.Options.UseBackColor = true;
            this.grvPeriode.Appearance.SelectedRow.Options.UseFont = true;
            this.grvPeriode.Appearance.SelectedRow.Options.UseForeColor = true;
            this.grvPeriode.Appearance.VertLine.BackColor = System.Drawing.Color.Silver;
            this.grvPeriode.Appearance.VertLine.Options.UseBackColor = true;
            this.grvPeriode.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.grvPeriode.Columns.AddRange(new DevExpress.XtraGrid.Columns.GridColumn[] {
            this.colVon,
            this.colBis,
            this.colStatus,
            this.colDefinitiv,
            this.colKontoZahlverkehr});
            this.grvPeriode.FocusRectStyle = DevExpress.XtraGrid.Views.Grid.DrawFocusRectStyle.None;
            this.grvPeriode.GridControl = this.grdPeriode;
            this.grvPeriode.GroupPanelText = "zu gruppierende Kolonnen in diesen Bereich ziehen";
            this.grvPeriode.Name = "grvPeriode";
            this.grvPeriode.OptionsBehavior.Editable = false;
            this.grvPeriode.OptionsCustomization.AllowFilter = false;
            this.grvPeriode.OptionsFilter.UseNewCustomFilterDialog = true;
            this.grvPeriode.OptionsNavigation.AutoFocusNewRow = true;
            this.grvPeriode.OptionsNavigation.UseTabKey = false;
            this.grvPeriode.OptionsView.ColumnAutoWidth = false;
            this.grvPeriode.OptionsView.ShowFilterPanelMode = DevExpress.XtraGrid.Views.Base.ShowFilterPanelMode.Never;
            this.grvPeriode.OptionsView.ShowGroupPanel = false;
            this.grvPeriode.OptionsView.ShowIndicator = false;
            //
            // colVon
            //
            this.colVon.Caption = "Periode von";
            this.colVon.FieldName = "PeriodeVon";
            this.colVon.Name = "colVon";
            this.colVon.Visible = true;
            this.colVon.VisibleIndex = 0;
            this.colVon.Width = 94;
            //
            // colBis
            //
            this.colBis.Caption = "Periode bis";
            this.colBis.FieldName = "PeriodeBis";
            this.colBis.Name = "colBis";
            this.colBis.Visible = true;
            this.colBis.VisibleIndex = 1;
            this.colBis.Width = 88;
            //
            // colStatus
            //
            this.colStatus.Caption = "Status";
            this.colStatus.FieldName = "KgPeriodeStatusCode";
            this.colStatus.Name = "colStatus";
            this.colStatus.Visible = true;
            this.colStatus.VisibleIndex = 2;
            this.colStatus.Width = 101;
            //
            // colDefinitiv
            //
            this.colDefinitiv.Caption = "definitiv bis";
            this.colDefinitiv.FieldName = "AbgeschlossenBis";
            this.colDefinitiv.Name = "colDefinitiv";
            this.colDefinitiv.Visible = true;
            this.colDefinitiv.VisibleIndex = 3;
            this.colDefinitiv.Width = 80;
            //
            // colKontoZahlverkehr
            //
            this.colKontoZahlverkehr.Caption = "Konto Zahlverkehr";
            this.colKontoZahlverkehr.FieldName = "KontoZahlverkehr";
            this.colKontoZahlverkehr.Name = "colKontoZahlverkehr";
            this.colKontoZahlverkehr.Visible = true;
            this.colKontoZahlverkehr.VisibleIndex = 4;
            this.colKontoZahlverkehr.Width = 325;
            //
            // edtPeriodeVon
            //
            this.edtPeriodeVon.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.edtPeriodeVon.DataMember = "PeriodeVon";
            this.edtPeriodeVon.DataSource = this.qryPeriode;
            this.edtPeriodeVon.EditValue = null;
            this.edtPeriodeVon.Location = new System.Drawing.Point(115, 346);
            this.edtPeriodeVon.Name = "edtPeriodeVon";
            this.edtPeriodeVon.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.True;
            this.edtPeriodeVon.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtPeriodeVon.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtPeriodeVon.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtPeriodeVon.Properties.Appearance.Options.UseBackColor = true;
            this.edtPeriodeVon.Properties.Appearance.Options.UseBorderColor = true;
            this.edtPeriodeVon.Properties.Appearance.Options.UseFont = true;
            this.edtPeriodeVon.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            serializableAppearanceObject4.BackColor = System.Drawing.Color.Bisque;
            serializableAppearanceObject4.Options.UseBackColor = true;
            this.edtPeriodeVon.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
            new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Glyph, "", 8, true, true, false, DevExpress.Utils.HorzAlignment.Center, ((System.Drawing.Image)(resources.GetObject("edtPeriodeVon.Properties.Buttons"))), new DevExpress.Utils.KeyShortcut(System.Windows.Forms.Keys.None), serializableAppearanceObject4)});
            this.edtPeriodeVon.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtPeriodeVon.Properties.Name = "editPeriodeVon.Properties";
            this.edtPeriodeVon.Properties.ShowToday = false;
            this.edtPeriodeVon.Size = new System.Drawing.Size(95, 24);
            this.edtPeriodeVon.TabIndex = 2;
            this.edtPeriodeVon.EditValueChanged += new System.EventHandler(this.edtPeriodeVon_EditValueChanged);
            //
            // edtPeriodeBis
            //
            this.edtPeriodeBis.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.edtPeriodeBis.DataMember = "PeriodeBis";
            this.edtPeriodeBis.DataSource = this.qryPeriode;
            this.edtPeriodeBis.EditValue = null;
            this.edtPeriodeBis.Location = new System.Drawing.Point(241, 346);
            this.edtPeriodeBis.Name = "edtPeriodeBis";
            this.edtPeriodeBis.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.True;
            this.edtPeriodeBis.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtPeriodeBis.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtPeriodeBis.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtPeriodeBis.Properties.Appearance.Options.UseBackColor = true;
            this.edtPeriodeBis.Properties.Appearance.Options.UseBorderColor = true;
            this.edtPeriodeBis.Properties.Appearance.Options.UseFont = true;
            this.edtPeriodeBis.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            serializableAppearanceObject3.BackColor = System.Drawing.Color.Bisque;
            serializableAppearanceObject3.Options.UseBackColor = true;
            this.edtPeriodeBis.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
            new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Glyph, "", 8, true, true, false, DevExpress.Utils.HorzAlignment.Center, ((System.Drawing.Image)(resources.GetObject("edtPeriodeBis.Properties.Buttons"))), new DevExpress.Utils.KeyShortcut(System.Windows.Forms.Keys.None), serializableAppearanceObject3)});
            this.edtPeriodeBis.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtPeriodeBis.Properties.Name = "editPeriodeBis.Properties";
            this.edtPeriodeBis.Properties.ShowToday = false;
            this.edtPeriodeBis.Size = new System.Drawing.Size(95, 24);
            this.edtPeriodeBis.TabIndex = 3;
            this.edtPeriodeBis.EditValueChanged += new System.EventHandler(this.edtPeriodeBis_EditValueChanged);
            //
            // edtBaZahlungsweg
            //
            this.edtBaZahlungsweg.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.edtBaZahlungsweg.DataMember = "BaZahlungswegID";
            this.edtBaZahlungsweg.DataSource = this.qryPeriode;
            this.edtBaZahlungsweg.Location = new System.Drawing.Point(115, 376);
            this.edtBaZahlungsweg.Name = "edtBaZahlungsweg";
            this.edtBaZahlungsweg.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtBaZahlungsweg.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtBaZahlungsweg.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtBaZahlungsweg.Properties.Appearance.Options.UseBackColor = true;
            this.edtBaZahlungsweg.Properties.Appearance.Options.UseBorderColor = true;
            this.edtBaZahlungsweg.Properties.Appearance.Options.UseFont = true;
            this.edtBaZahlungsweg.Properties.AppearanceDropDown.BackColor = System.Drawing.Color.BlanchedAlmond;
            this.edtBaZahlungsweg.Properties.AppearanceDropDown.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.edtBaZahlungsweg.Properties.AppearanceDropDown.Options.UseBackColor = true;
            this.edtBaZahlungsweg.Properties.AppearanceDropDown.Options.UseFont = true;
            this.edtBaZahlungsweg.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            serializableAppearanceObject2.BackColor = System.Drawing.Color.Bisque;
            serializableAppearanceObject2.Options.UseBackColor = true;
            this.edtBaZahlungsweg.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
            new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo, "", -1, true, true, false, DevExpress.Utils.HorzAlignment.Center, null, new DevExpress.Utils.KeyShortcut(System.Windows.Forms.Keys.None), serializableAppearanceObject2)});
            this.edtBaZahlungsweg.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtBaZahlungsweg.Properties.Columns.AddRange(new DevExpress.XtraEditors.Controls.LookUpColumnInfo[] {
            new DevExpress.XtraEditors.Controls.LookUpColumnInfo("Text")});
            this.edtBaZahlungsweg.Properties.DisplayMember = "Text";
            this.edtBaZahlungsweg.Properties.NullText = "";
            this.edtBaZahlungsweg.Properties.ShowFooter = false;
            this.edtBaZahlungsweg.Properties.ShowHeader = false;
            this.edtBaZahlungsweg.Properties.ValueMember = "Code";
            this.edtBaZahlungsweg.Size = new System.Drawing.Size(413, 24);
            this.edtBaZahlungsweg.TabIndex = 5;
            //
            // btnAktiv
            //
            this.btnAktiv.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.btnAktiv.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnAktiv.Location = new System.Drawing.Point(401, 416);
            this.btnAktiv.Name = "btnAktiv";
            this.btnAktiv.Size = new System.Drawing.Size(101, 24);
            this.btnAktiv.TabIndex = 6;
            this.btnAktiv.Text = "Aktiv / Inaktiv";
            this.btnAktiv.UseCompatibleTextRendering = true;
            this.btnAktiv.UseVisualStyleBackColor = false;
            this.btnAktiv.Click += new System.EventHandler(this.btnAktiv_Click);
            //
            // btnAbschluss
            //
            this.btnAbschluss.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.btnAbschluss.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnAbschluss.Location = new System.Drawing.Point(508, 416);
            this.btnAbschluss.Name = "btnAbschluss";
            this.btnAbschluss.Size = new System.Drawing.Size(101, 24);
            this.btnAbschluss.TabIndex = 7;
            this.btnAbschluss.Text = "Abschluss";
            this.btnAbschluss.UseCompatibleTextRendering = true;
            this.btnAbschluss.UseVisualStyleBackColor = false;
            this.btnAbschluss.Click += new System.EventHandler(this.btnAbschluss_Click);
            //
            // btnSaldiVortragen
            //
            this.btnSaldiVortragen.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.btnSaldiVortragen.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnSaldiVortragen.Location = new System.Drawing.Point(616, 416);
            this.btnSaldiVortragen.Name = "btnSaldiVortragen";
            this.btnSaldiVortragen.Size = new System.Drawing.Size(101, 24);
            this.btnSaldiVortragen.TabIndex = 8;
            this.btnSaldiVortragen.Text = "Saldi vortragen";
            this.btnSaldiVortragen.UseCompatibleTextRendering = true;
            this.btnSaldiVortragen.UseVisualStyleBackColor = false;
            this.btnSaldiVortragen.Click += new System.EventHandler(this.btnSaldiVortragen_Click);
            //
            // kissLabel2
            //
            this.kissLabel2.LabelStyle = KiSS4.Gui.LabelStyleType.DataView;
            this.kissLabel2.Location = new System.Drawing.Point(5, 156);
            this.kissLabel2.Name = "kissLabel2";
            this.kissLabel2.Size = new System.Drawing.Size(80, 16);
            this.kissLabel2.TabIndex = 302;
            this.kissLabel2.Text = "Perioden";
            this.kissLabel2.UseCompatibleTextRendering = true;
            //
            // lblPeriodeVon
            //
            this.lblPeriodeVon.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lblPeriodeVon.Location = new System.Drawing.Point(6, 346);
            this.lblPeriodeVon.Name = "lblPeriodeVon";
            this.lblPeriodeVon.Size = new System.Drawing.Size(79, 24);
            this.lblPeriodeVon.TabIndex = 305;
            this.lblPeriodeVon.Text = "Periode von";
            this.lblPeriodeVon.UseCompatibleTextRendering = true;
            //
            // lblPeriodeBis
            //
            this.lblPeriodeBis.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lblPeriodeBis.Location = new System.Drawing.Point(216, 346);
            this.lblPeriodeBis.Name = "lblPeriodeBis";
            this.lblPeriodeBis.Size = new System.Drawing.Size(23, 24);
            this.lblPeriodeBis.TabIndex = 306;
            this.lblPeriodeBis.Text = "bis";
            this.lblPeriodeBis.UseCompatibleTextRendering = true;
            //
            // panel1
            //
            this.panel1.Controls.Add(this.picTitel);
            this.panel1.Controls.Add(this.lblTitel);
            this.panel1.Dock = System.Windows.Forms.DockStyle.Top;
            this.panel1.Location = new System.Drawing.Point(0, 0);
            this.panel1.Name = "panel1";
            this.panel1.Size = new System.Drawing.Size(743, 24);
            this.panel1.TabIndex = 309;
            //
            // picTitel
            //
            this.picTitel.Image = ((System.Drawing.Image)(resources.GetObject("picTitel.Image")));
            this.picTitel.Location = new System.Drawing.Point(5, 5);
            this.picTitel.Name = "picTitel";
            this.picTitel.Size = new System.Drawing.Size(16, 16);
            this.picTitel.TabIndex = 293;
            this.picTitel.TabStop = false;
            //
            // lblTitel
            //
            this.lblTitel.LabelStyle = KiSS4.Gui.LabelStyleType.TitleLabel;
            this.lblTitel.Location = new System.Drawing.Point(25, 5);
            this.lblTitel.Name = "lblTitel";
            this.lblTitel.Size = new System.Drawing.Size(542, 15);
            this.lblTitel.TabIndex = 0;
            this.lblTitel.Text = "Perioden";
            this.lblTitel.UseCompatibleTextRendering = true;
            //
            // label40
            //
            this.label40.Location = new System.Drawing.Point(5, 62);
            this.label40.Name = "label40";
            this.label40.Size = new System.Drawing.Size(63, 24);
            this.label40.TabIndex = 311;
            this.label40.Text = "Name";
            this.label40.UseCompatibleTextRendering = true;
            //
            // edtAdresse
            //
            this.edtAdresse.EditMode = Kiss.Interfaces.UI.EditModeType.ReadOnly;
            this.edtAdresse.Location = new System.Drawing.Point(113, 97);
            this.edtAdresse.Name = "edtAdresse";
            this.edtAdresse.Properties.Appearance.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.edtAdresse.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtAdresse.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtAdresse.Properties.Appearance.Options.UseBackColor = true;
            this.edtAdresse.Properties.Appearance.Options.UseBorderColor = true;
            this.edtAdresse.Properties.Appearance.Options.UseFont = true;
            this.edtAdresse.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtAdresse.Properties.Name = "editPlzOrt.Properties";
            this.edtAdresse.Properties.ReadOnly = true;
            this.edtAdresse.Size = new System.Drawing.Size(318, 24);
            this.edtAdresse.TabIndex = 312;
            //
            // edtBaPersonID
            //
            this.edtBaPersonID.EditMode = Kiss.Interfaces.UI.EditModeType.ReadOnly;
            this.edtBaPersonID.Location = new System.Drawing.Point(361, 61);
            this.edtBaPersonID.Name = "edtBaPersonID";
            this.edtBaPersonID.Properties.Appearance.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.edtBaPersonID.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtBaPersonID.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtBaPersonID.Properties.Appearance.Options.UseBackColor = true;
            this.edtBaPersonID.Properties.Appearance.Options.UseBorderColor = true;
            this.edtBaPersonID.Properties.Appearance.Options.UseFont = true;
            this.edtBaPersonID.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtBaPersonID.Properties.Name = "editMandantNr.Properties";
            this.edtBaPersonID.Properties.ReadOnly = true;
            this.edtBaPersonID.Size = new System.Drawing.Size(70, 24);
            this.edtBaPersonID.TabIndex = 313;
            //
            // edtMT
            //
            this.edtMT.EditMode = Kiss.Interfaces.UI.EditModeType.ReadOnly;
            this.edtMT.Location = new System.Drawing.Point(113, 120);
            this.edtMT.Name = "edtMT";
            this.edtMT.Properties.Appearance.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.edtMT.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtMT.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtMT.Properties.Appearance.Options.UseBackColor = true;
            this.edtMT.Properties.Appearance.Options.UseBorderColor = true;
            this.edtMT.Properties.Appearance.Options.UseFont = true;
            this.edtMT.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtMT.Properties.Name = "editMT.Properties";
            this.edtMT.Properties.ReadOnly = true;
            this.edtMT.Size = new System.Drawing.Size(318, 24);
            this.edtMT.TabIndex = 314;
            //
            // label10
            //
            this.label10.Location = new System.Drawing.Point(5, 120);
            this.label10.Name = "label10";
            this.label10.Size = new System.Drawing.Size(102, 24);
            this.label10.TabIndex = 315;
            this.label10.Text = "Beist. oder Vorm.";
            this.label10.UseCompatibleTextRendering = true;
            //
            // label1
            //
            this.label1.Location = new System.Drawing.Point(5, 97);
            this.label1.Name = "label1";
            this.label1.Size = new System.Drawing.Size(63, 24);
            this.label1.TabIndex = 316;
            this.label1.Text = "Adresse";
            this.label1.UseCompatibleTextRendering = true;
            //
            // kissLabel3
            //
            this.kissLabel3.LabelStyle = KiSS4.Gui.LabelStyleType.DataView;
            this.kissLabel3.Location = new System.Drawing.Point(5, 39);
            this.kissLabel3.Name = "kissLabel3";
            this.kissLabel3.Size = new System.Drawing.Size(350, 16);
            this.kissLabel3.TabIndex = 319;
            this.kissLabel3.Text = "Person mit zivilrechtlicher Massnahme";
            this.kissLabel3.UseCompatibleTextRendering = true;
            //
            // lblBaZahlungsweg
            //
            this.lblBaZahlungsweg.Anchor = ((System.Windows.Forms.AnchorStyles)((System.Windows.Forms.AnchorStyles.Bottom | System.Windows.Forms.AnchorStyles.Left)));
            this.lblBaZahlungsweg.Location = new System.Drawing.Point(6, 376);
            this.lblBaZahlungsweg.Name = "lblBaZahlungsweg";
            this.lblBaZahlungsweg.Size = new System.Drawing.Size(101, 24);
            this.lblBaZahlungsweg.TabIndex = 321;
            this.lblBaZahlungsweg.Text = "Konto Zahlverkehr";
            this.lblBaZahlungsweg.UseCompatibleTextRendering = true;
            //
            // chkPeriodenUeberschneidungZulassen
            //
            this.chkPeriodenUeberschneidungZulassen.EditValue = false;
            this.chkPeriodenUeberschneidungZulassen.Location = new System.Drawing.Point(457, 66);
            this.chkPeriodenUeberschneidungZulassen.Name = "chkPeriodenUeberschneidungZulassen";
            this.chkPeriodenUeberschneidungZulassen.Properties.Appearance.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(231)))));
            this.chkPeriodenUeberschneidungZulassen.Properties.Appearance.Options.UseBackColor = true;
            this.chkPeriodenUeberschneidungZulassen.Properties.Caption = "Periodenüberschneidung zulassen";
            this.chkPeriodenUeberschneidungZulassen.Size = new System.Drawing.Size(190, 19);
            this.chkPeriodenUeberschneidungZulassen.TabIndex = 322;
            this.chkPeriodenUeberschneidungZulassen.Visible = false;
            //
            // CtlKgPeriode
            //
            this.ActiveSQLQuery = this.qryPeriode;
            this.Controls.Add(this.chkPeriodenUeberschneidungZulassen);
            this.Controls.Add(this.lblBaZahlungsweg);
            this.Controls.Add(this.kissLabel3);
            this.Controls.Add(this.label1);
            this.Controls.Add(this.label10);
            this.Controls.Add(this.edtMT);
            this.Controls.Add(this.edtBaPersonID);
            this.Controls.Add(this.edtAdresse);
            this.Controls.Add(this.label40);
            this.Controls.Add(this.panel1);
            this.Controls.Add(this.lblPeriodeBis);
            this.Controls.Add(this.lblPeriodeVon);
            this.Controls.Add(this.kissLabel2);
            this.Controls.Add(this.btnSaldiVortragen);
            this.Controls.Add(this.btnAbschluss);
            this.Controls.Add(this.btnAktiv);
            this.Controls.Add(this.edtBaZahlungsweg);
            this.Controls.Add(this.edtPeriodeBis);
            this.Controls.Add(this.edtPeriodeVon);
            this.Controls.Add(this.grdPeriode);
            this.Controls.Add(this.edtMandant);
            this.Name = "CtlKgPeriode";
            this.Size = new System.Drawing.Size(743, 449);
            this.Load += new System.EventHandler(this.CtlKgPeriode_Load);
            ((System.ComponentModel.ISupportInitialize)(this.edtMandant.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.grdPeriode)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPeriode)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.grvPeriode)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtPeriodeVon.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtPeriodeBis.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaZahlungsweg.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaZahlungsweg)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblPeriodeVon)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblPeriodeBis)).EndInit();
            this.panel1.ResumeLayout(false);
            ((System.ComponentModel.ISupportInitialize)(this.picTitel)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblTitel)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.label40)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtAdresse.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBaPersonID.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtMT.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.label10)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.label1)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblBaZahlungsweg)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.chkPeriodenUeberschneidungZulassen.Properties)).EndInit();
            this.ResumeLayout(false);
        }

        #endregion

        #region Dispose

        /// <summary>
        /// Clean up any resources being used.
        /// </summary>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                if ((components != null))
                {
                    components.Dispose();
                }
            }
            base.Dispose(disposing);
        }

        #endregion

        #region Public Methods

        public void Init(string Name, Image TitleImage, int FaLeistungID, int BaPersonID)
        {
            lblTitel.Text = Name;
            picTitel.Image = TitleImage;
            faLeistungID = FaLeistungID;
            baPersonID = BaPersonID;

            FillZahlungswegLookup(baPersonID);
        }

        #endregion

        #region Private Methods

        private void btnAbschluss_Click(object sender, System.EventArgs e)
        {
            if (baPersonID == 0) return;  //kein Mandant ausgewählt
            if (qryPeriode.Count == 0) return; //Mandant ohne Periode
            if (((int)qryPeriode["KgPeriodeStatusCode"]) == 3) return;  //Periode ist bereits abgeschlossen

            SqlQuery qry;

            //gibt es überhaupt Buchungen in dieser Periode
            qry = DBUtil.OpenSQL(
                "select count(*) Count from KgBuchung where KgPeriodeID = {0}",
                qryPeriode["KgPeriodeID"]);

            if (((int)qry["Count"]) == 0)
            {
                KissMsg.ShowInfo("Periode kann nicht abgeschlossen werden, da noch keine Buchungen vorhanden sind");
                return;
            }

            //gibt es noch Buchungen mit Buchungsdatum ausserhalb der abzuschliessenden Periode
            try
            {
                int Count = (int)DBUtil.ExecuteScalarSQL(@"
                    select count(*)
                    from   KgBuchung BUC
                           inner join KgPeriode PER  on PER.KgPeriodeID = BUC.KgPeriodeID
                    where  PER.KgPeriodeID = {0} and
                           not BUC.Buchungsdatum between PER.PeriodeVon and PER.PeriodeBis",
                    qryPeriode["KgPeriodeID"]);

                if (Count > 0)
                {
                    KissMsg.ShowInfo(string.Format("Es gibt in dieser Periode noch {0} Buchung(en) mit einem Buchungsdatum ausserhalb der Periode.", Count));
                    return;
                }
            }
            catch (Exception ex)
            {
                KissMsg.ShowInfo(ex.Message);
                return;
            }

            //Ist BilanzSaldo ausgeglichen ?
            qry = DBUtil.OpenSQL(@"
                select sum(case when KTOS.KontoNr is null then 0 else BUC.Betrag end -
                           case when KTOH.KontoNr is null then 0 else BUC.Betrag end) Saldo
                from   KgBuchung BUC
                       left join KgKonto KTOS on KTOS.KgPeriodeID = BUC.KgPeriodeID and
                                                 KTOS.KontoNr = BUC.SollKtoNr and
                                                 KTOS.KgKontoKlasseCode in (1,2)
                       left join KgKonto KTOH on KTOH.KgPeriodeID = BUC.KgPeriodeID and
                                                 KTOH.KontoNr = BUC.HabenKtoNr and
                                                 KTOH.KgKontoKlasseCode in (1,2)
                where  BUC.KgPeriodeID = {0}",
                qryPeriode["KgPeriodeID"]);

            //an dieser Stelle: prüfen, ob noch offene Zahlungen etc..

            if (((decimal)qry["Saldo"]) != 0)
            {
                string SollKtoNr;
                string HabenKtoNr;
                string Buchungstext;

                string PassivKtoNr = GetKontoartKonto(4);  //Kapital Klient
                if (PassivKtoNr == null) return;

                if (((decimal)qry["Saldo"]) > 0)
                {
                    Buchungstext = "Vermögenszunahme";
                    HabenKtoNr = PassivKtoNr;
                    SollKtoNr = GetKontoartKonto(6); //Vermögenszunahem
                    if (SollKtoNr == null) return;
                }
                else
                {
                    Buchungstext = "Vermögensabnahme";
                    SollKtoNr = PassivKtoNr;
                    HabenKtoNr = GetKontoartKonto(5); //Vermögensabnahme
                    if (HabenKtoNr == null) return;
                }

                //Fragen, ob Saldo auf Klienten-Kapital verbucht werden soll
                if (!KissMsg.ShowQuestion(string.Format(
                    "Des Bilanzsaldo beträgt CHF {0:N2}" +
                    "\r\nSoll dieser Saldo automatisch verbucht und die Periode abgeschlossen werden?", qry["Saldo"]), true))
                {
                    return;
                }

                try
                {
                    //Verbuchen des Bilanzsaldos
                    DBUtil.ExecSQLThrowingException(@"
                        insert KgBuchung
                          (KgPeriodeID,KgBuchungTypCode,BuchungsDatum,ValutaDatum,
                           SollKtoNr,HabenKtoNr,Betrag,Text,ErstelltDatum)
                        values ({0},3,{1},{2},{3},{4},{5},{6},{7})",
                        qryPeriode["KgPeriodeID"],
                        qryPeriode["PeriodeBis"],
                        qryPeriode["PeriodeBis"],
                        SollKtoNr,
                        HabenKtoNr,
                        Math.Abs((decimal)qry["Saldo"]),
                        Buchungstext,
                        DateTime.Now);
                }
                catch (Exception ex)
                {
                    KissMsg.ShowError(ex.Message);
                    return;
                }
            }
            else
            {
                if (!KissMsg.ShowQuestion("Der Bilanzsaldo dieser Periode beträgt CHF 0.00\r\nSoll diese Periode abgeschlossen werden?", true))
                {
                    return;
                }
            }

            //Periode abschliessen
            qryPeriode["KgPeriodeStatusCode"] = 3;
            qryPeriode.Post();

            //Saldi automatisch vortragen
            DBUtil.ExecSQL("exec spKgSaldiVortragen {0}", baPersonID);
        }

        private void btnAktiv_Click(object sender, System.EventArgs e)
        {
            switch (((int)qryPeriode["KgPeriodeStatusCode"]))
            {
                case 1:
                    qryPeriode["KgPeriodeStatusCode"] = 2;
                    if (qryPeriode.Post())
                    {
                        qryPeriode.EnableBoundFields(false);
                        //Saldi automatisch vortragen
                        DBUtil.ExecSQL("exec spKgSaldiVortragen {0}", baPersonID);
                    }
                    break;

                case 2:
                    qryPeriode["KgPeriodeStatusCode"] = 1;
                    if (qryPeriode.Post())
                    {
                        qryPeriode.EnableBoundFields(true);
                        //Saldi automatisch vortragen
                        DBUtil.ExecSQL("exec spKgSaldiVortragen {0}", baPersonID);
                    }
                    break;

                case 3:
                    //sollte gar nicht vorkommen
                    KissMsg.ShowInfo("CtlKgPeriode", "PeriodeBereitsAbgeschlossen", "Periode ist bereits abgeschlossen");
                    break;
            }
        }

        private void btnSaldiVortragen_Click(object sender, System.EventArgs e)
        {
            //if (qryMandant.Count == 0) return;
            if (qryPeriode.Count <= 1) return;

            if (KissMsg.ShowQuestion("CtlKgPeriode", "EroeffungssaldiNeuBerechnen", "Sollen die Eröffnungssaldi aller aktiven Perioden aufgrund der Vorperiode neu berechnet werden ?"))
            {
                try
                {
                    DBUtil.ExecSQLThrowingException("exec spKgSaldiVortragen {0}", baPersonID);
                    KissMsg.ShowInfo("CtlFibuPeriode", "SaldiVorgetragen", "Alle Saldi wurden vorgetragen.");
                }
                catch
                {
                }
            }
        }

        private void BuchungenDokumenteUndMT940DatenNeuZuordnen()
        {
            try
            {
                int Count = (int)DBUtil.ExecuteScalarSQL(@"
                    update BUC
                    set    KgPeriodeID = PER2.KgPeriodeID
                    from   KgBuchung BUC
                           inner join KgPeriode  PER  on PER.KgPeriodeID = BUC.KgPeriodeID
                           inner join FaLeistung LEI  on LEI.FaLeistungID = PER.FaLeistungID
                           inner join KgPeriode  PER2 on PER2.FaLeistungID = PER.FaLeistungID and
                                                         PER2.KgPeriodeStatusCode IN (1,2) and
                                                         BUC.Buchungsdatum between PER2.PeriodeVon and PER2.PeriodeBis
                    where  LEI.BaPersonID = {0} and
                           not BUC.Buchungsdatum between PER.PeriodeVon and PER.PeriodeBis

                    -- Buchungen, für die keine passende, aktive Periode gefunden wurden
                    select count(*)
                    from   KgBuchung BUC
                           inner join KgPeriode PER  on PER.KgPeriodeID = BUC.KgPeriodeID
                           inner join FaLeistung LEI  on LEI.FaLeistungID = PER.FaLeistungID
                    where  LEI.BaPersonID = {0} and
                           not BUC.Buchungsdatum between PER.PeriodeVon and PER.PeriodeBis

                    -- Konto-Dokumenten-Zuordnung anpassen
                    UPDATE KgDokument SET KgKontoID = KON2.KgKontoID
                    FROM KgDokument DOK
                      INNER JOIN KgKonto KON ON KON.KgKontoID = DOK.KgKontoID AND KON.KgKontoKlasseCode IN (1,2) AND KON.KontoGruppe = 0
                      INNER JOIN KgPeriode PER ON PER.KgPeriodeID = KON.KgPeriodeID
                        AND PER.KgPeriodeStatusCode IN (1,2)
                      INNER JOIN KgPeriode PER2 ON PER2.FaLeistungID = PER.FaLeistungID AND DOK.Stichtag BETWEEN PER2.PeriodeVon AND PER2.PeriodeBis
                        AND PER2.KgPeriodeStatusCode IN (1,2)
                      INNER JOIN KgKonto KON2 ON KON2.KgPeriodeID = PER2.KgPeriodeID AND KON2.KontoNr = KON.KontoNr
                        AND KON2.KgKontoKlasseCode IN (1,2) AND KON2.KontoGruppe = 0
                    WHERE DOK.KgDokumentID IN
                    (
                      -- Alle falsch zugeordneten Dokumente, für die es eine korrekte Periode und Konto gibt
                      SELECT DOK.KgDokumentID--, *
                      FROM FaLeistung LEI
                        INNER JOIN KgPeriode PER ON PER.FaLeistungID = LEI.FaLeistungID
                          AND PER.KgPeriodeStatusCode IN (1,2)
                        INNER JOIN KgKonto KON ON KON.KgPeriodeID = PER.KgPeriodeID AND KON.KgKontoKlasseCode IN (1,2) AND KON.KontoGruppe = 0 /*Kontodokumente gibt es nur für Aktiv/Passivkonten*/
                        INNER JOIN KgDokument DOK ON DOK.KgKontoID = KON.KgKontoID AND DOK.Stichtag IS NOT NULL
                        INNER JOIN KgPeriode PER2 ON PER2.FaLeistungID = LEI.FaLeistungID AND DOK.Stichtag BETWEEN PER2.PeriodeVon AND PER2.PeriodeBis
                          AND PER2.KgPeriodeStatusCode IN (1,2)
                        INNER JOIN KgKonto KON2 ON KON2.KgPeriodeID = PER2.KgPeriodeID AND KON2.KontoNr = KON.KontoNr
                          AND KON2.KgKontoKlasseCode IN (1,2) AND KON2.KontoGruppe = 0
                      WHERE LEI.BaPersonID = {0} AND
                        --LEI.BaPersonID = 154378 AND
                        LEI.FaProzessCode = 500 AND
                        DOK.Stichtag NOT BETWEEN PER.PeriodeVon AND PER.PeriodeBis
                    )

                    -- MT940-Daten neu zuordnen
                    DECLARE @BaPersonID int, @BankkontoNummer varchar(50), @BankKontoNummer_MT940_Format varchar(50)
                    SELECT @BaPersonID = LEI.BaPersonID, @BankkontoNummer = ZAH.IBANNummer, @BankKontoNummer_MT940_Format = ZAH.BankKontoNummer_MT940_Format
                    FROM dbo.KgPeriode PER
                        INNER JOIN dbo.FaLeistung LEI ON LEI.FaLeistungID = PER.FaLeistungID
                        INNER JOIN dbo.BaZahlungsweg ZAH ON ZAH.BaZahlungswegID = PER.BaZahlungswegID
                    WHERE PER.KgPeriodeID = {1} AND PER.KgPeriodeStatusCode = 1 /*aktiv*/
                    IF @BaPersonID IS NOT NULL AND @BankkontoNummer IS NOT NULL AND @BankKontoNummer_MT940_Format IS NOT NULL AND NOT EXISTS
                        ( -- Zuordnung muss eindeutig sein.
                        SELECT TOP 1 ZAH.BaPersonID
                        FROM BaZahlungsweg ZAH
                            INNER JOIN KgPeriode PER ON PER.BaZahlungswegID = ZAH.BaZahlungswegID
                            INNER JOIN FaLeistung LEI ON LEI.FaLeistungID = PER.FaLeistungID AND (LEI.DatumBis IS NULL OR LEI.DatumBis > GetDate())
                        WHERE ZAH.IBANNummer = @BankkontoNummer AND ZAH.BaPersonID <> @BaPersonID
                        ) BEGIN
                        UPDATE KgZahlungseingang SET BaPersonID = @BaPersonID
                        WHERE (PscdKontoKlient = @BankKontoNummer_MT940_Format OR PscdKontoKlient = @BankkontoNummer)
                        AND (BaPersonID <> @BaPersonID OR BaPersonID IS NULL)
                        UPDATE SstMT940Saldo SET BaPersonID = @BaPersonID
                        WHERE Kontonummer = @BankKontoNummer_MT940_Format OR Kontonummer = @BankkontoNummer
                    END
                    ",
                    baPersonID, qryPeriode["KgPeriodeID"]);

                if (Count != 0)
                {
                    KissMsg.ShowInfo(string.Format(
                        "{0} Buchung(en) konnten keinen Perioden zugeordnet werden." +
                        "\r\nMögliche Ursachen sind fehlende oder abgeschlossene Perioden.", Count));
                }
            }
            catch (Exception ex)
            {
                KissMsg.ShowInfo(ex.Message);
            }
        }

        private void CtlKgPeriode_Load(object sender, System.EventArgs e)
        {
            colStatus.ColumnEdit = grdPeriode.GetLOVLookUpEdit("KgPeriodeStatus");

            chkPeriodenUeberschneidungZulassen.Visible = DBUtil.UserHasRight("CtlKgPeriode_PeriodenUeberschneidung");

            if (baPersonID > 0)
            {
                SqlQuery qry = DBUtil.OpenSQL(@"
                    SELECT Name    = PRS.NameVorname,
                           Adresse = PRS.Wohnsitz,
                           [Beist. oder Vorm.] = dbo.fnVmGetMTName(PRS.BaPersonID)
                    FROM   vwPerson PRS
                    WHERE  PRS.BaPersonID = {0}",
                    baPersonID);

                edtBaPersonID.EditValue = baPersonID;
                edtMandant.EditValue = qry["Name"];
                edtAdresse.EditValue = qry["Adresse"];
                edtMT.EditValue = qry["Beist. oder Vorm."];

                edtMandant.EditMode = EditModeType.ReadOnly;
            }
            else
            {
                edtMandant.EditMode = EditModeType.Normal;
            }

            btnAktiv.Enabled = false;
            btnAbschluss.Enabled = false;

            if (faLeistungID == 0)
                qryPeriode.Fill(baPersonID, DBNull.Value);
            else
                qryPeriode.Fill(baPersonID, faLeistungID);

            FillZahlungswegLookup(baPersonID);
        }

        private void edtMandant_UserModifiedFld(object sender, KiSS4.Gui.UserModifiedFldEventArgs e)
        {
            string SearchString = edtMandant.EditValue.ToString().Replace("*", "%").Replace("?", "_").Replace(" ", "%");

            if (DBUtil.IsEmpty(SearchString))
            {
                if (e.ButtonClicked)
                {
                    SearchString = "%";
                }
                else
                {
                    baPersonID = -1;
                    edtMandant.EditValue = null;
                    edtBaPersonID.EditValue = null;
                    edtAdresse.EditValue = null;
                    edtMT.EditValue = null;
                    qryPeriode.DataTable.Rows.Clear();
                    qryPeriode.EnableBoundFields(false);
                    return;
                }
            }

            KissLookupDialog dlg = new KissLookupDialog();
            e.Cancel = !dlg.SearchData(@"
              SELECT distinct
                     BaPersonID$      = PRS.BaPersonID,
                     [Personen-Nr.]   = PRS.BaPersonID,
                     Name             = PRS.NameVorname,
                     Geburtsdatum     = PRS.Geburtsdatum,
                     [Alter]          = PRS.[Alter],
                     Adresse          = PRS.Wohnsitz,
                     [Beist. oder Vorm.] = dbo.fnVmGetMTName(PRS.BaPersonID)
              FROM   vwPerson PRS
                     inner join FaLeistung LEI on LEI.BaPersonID = PRS.BaPersonID and
                                                  LEI.FaProzessCode = 500
              WHERE  PRS.NameVorname LIKE '%' + {0} + '%'
              ORDER BY PRS.NameVorname",
              SearchString,
              e.ButtonClicked, null, null, null);

            if (!e.Cancel)
            {
                baPersonID = (int)dlg["BaPersonID$"];
                edtMandant.EditValue = dlg["Name"];
                edtBaPersonID.EditValue = dlg["BaPersonID$"];
                edtAdresse.EditValue = dlg["Adresse"];
                edtMT.EditValue = dlg["Beist. oder Vorm."];

                FillZahlungswegLookup(baPersonID);
                if (faLeistungID == 0)
                    qryPeriode.Fill(baPersonID, DBNull.Value);
                else
                    qryPeriode.Fill(baPersonID, faLeistungID);
            }
        }

        private void edtPeriodeBis_EditValueChanged(object sender, EventArgs e)
        {
            FillZahlungswegLookup(baPersonID);
        }

        private void edtPeriodeVon_EditValueChanged(object sender, EventArgs e)
        {
            FillZahlungswegLookup(baPersonID);
        }

        private void FillZahlungswegLookup(int BaPersonID)
        {
            edtBaZahlungsweg.LoadQuery(DBUtil.OpenSQL(@"
                SELECT
		               Code = ZAH.BaZahlungswegID,
                       Text = EIZ.ShortText +
				                 ISNULL(', ' + dbo.fnTnToPc(ISNULL(ZAH.PostKontoNummer,BNK.PCKontoNr)),'') +
				                 ISNULL(', ' + BNK.Name, '') +
				                 ISNULL(', ' + ZAH.BankKontoNummer, '') +
				                 ISNULL(', ' + ZAH.IBANNummer,'')
                FROM  dbo.BaZahlungsweg ZAH WITH (READUNCOMMITTED)
                       LEFT  JOIN dbo.BaBank         BNK  WITH (READUNCOMMITTED) ON BNK.BaBankID = ZAH.BaBankID
                       LEFT  JOIN dbo.XLOVCode       EIZ  WITH (READUNCOMMITTED) ON EIZ.LOVName = 'BgEinzahlungsschein' AND
                                                              EIZ.Code = ZAH.EinzahlungsscheinCode
                WHERE ZAH.BaPersonID = {0}
                    AND ZAH.BaKontoartCode = 4 -- 4 = Verkehrskonto
                    AND [dbo].[fnDatumUeberschneidung] (ISNULL(ZAH.DatumVon, '1900-01-01'), ISNULL(ZAH.DatumBis, '2999-12-31'), {1}, {2}) = 1
            UNION ALL
                SELECT null,null
                ORDER BY 1 desc",
                BaPersonID, edtPeriodeVon.EditValue, edtPeriodeBis.EditValue));
        }

        private string GetKontoartKonto(int KgKontoartCode)
        {
            SqlQuery qry = DBUtil.OpenSQL(@"
                select KontoNr
                from   KgKonto
                where  KgPeriodeID = {0} and
                       KgKontoartCode = {1}",
                qryPeriode["KgPeriodeID"],
                KgKontoartCode);

            if (qry.Count != 1)
            {
                string Kontoart = (string)DBUtil.ExecuteScalarSQL("select Text from XLOVCode where LOVName = 'KgKontoart' and Code = {0}", KgKontoartCode);

                if (qry.Count == 0)
                {
                    KissMsg.ShowInfo("CtlKgPeriode", "KeinKontoInPeriode", "Der Kontenplan dieser Periode weist kein Konto mit der Kontoart '{0}' auf!", 0, 0, Kontoart);
                }

                if (qry.Count > 1)
                {
                    KissMsg.ShowInfo("CtlKgPeriode", "MehrAlsEinKontoInPeriode", "Der Kontenplan dieser Periode weist mehr als ein Konto mit der Kontoart '{0}' auf!", 0, 0, Kontoart);
                }
                return null;
            }

            return qry["KontoNr"].ToString();
        }

        private void qryPeriode_AfterDelete(object sender, System.EventArgs e)
        {
            FormController.SendMessage("FrmFall", "Action", "RefreshTree");
        }

        private void qryPeriode_AfterInsert(object sender, System.EventArgs e)
        {
            qryPeriode["FaLeistungID"] = faLeistungID;
            qryPeriode["KgPeriodeStatusCode"] = 1; // aktiv

            // nächste 2-jährige Periode vorschlagen
            SqlQuery qry = DBUtil.OpenSQL(@"
                select max(PeriodeBis) MaxDate
                from    KgPeriode PER
                    inner join FaLeistung LEI on LEI.FaLeistungID = PER.FaLeistungID
                where   LEI.BaPersonID = {0}",
                baPersonID);

            if (!DBUtil.IsEmpty(qry["MaxDate"]))
            {
                DateTime D = (DateTime)qry["MaxDate"];
                qryPeriode["PeriodeVon"] = D.AddDays(1);
                qryPeriode["PeriodeBis"] = D.AddYears(2);
            }

            FillZahlungswegLookup(baPersonID); //refresh, falls inzwischen ein BaZahlungsweg erfasst wurde

            //Konto Zahlverkehr einfüllen, falls genau 1 BaZahlungsweg im Lookup vorhanden
            qry = (SqlQuery)edtBaZahlungsweg.Properties.DataSource;
            if (qry.Count == 1) qryPeriode["BaZahlungswegID"] = qry["Code"];

            qryPeriode.EnableBoundFields(true);
            qryPeriode.RowModified = true; //damit beim Post() auch wirklich gespeichert wird!

            edtPeriodeVon.Focus();
        }

        private void qryPeriode_AfterPost(object sender, System.EventArgs e)
        {
            //Wenn neue Periode: Kopiere StandardKontenplan bzw. Kontenplan der letzten Periode auf neue Periode
            if (SaveRowState == DataRowState.Added)
            {
                //Letzte Periode des Klienten bestimmen
                SqlQuery qry = DBUtil.OpenSQL(@"
                    select  top 1 KgPeriodeID
                    from    KgPeriode PER
                        inner join FaLeistung LEI on LEI.FaLeistungID = PER.FaLeistungID
                    where   LEI.BaPersonID = {0} and
                            KgPeriodeID <> {1}
                    order by PeriodeBis desc",
                    baPersonID,
                    qryPeriode["KgPeriodeID"]);

                if (qry.Count == 0)
                {
                    //StandardKontenplan kopieren
                    DBUtil.ExecSQL(@"
                        insert   KgKonto
                            (KgPeriodeID,GruppeKontoID,GruppePosition,KontoGruppe,KgKontoKlasseCode,
                             VorsaldoUebertrag,KgKontoartCode,KontoNr,KontoName,Vorsaldo,SortKey)
                        select   {0},GruppeKontoID,GruppePosition,KontoGruppe,KgKontoKlasseCode,
                             VorsaldoUebertrag,KgKontoartCode,KontoNr,KontoName,0,SortKey
                        from     KgKonto
                            where KgPeriodeID is null

                    update KTO
                    set    GruppeKontoID = KTO3.KgKontoID
                    from   KgKonto KTO
                                   inner join KgKonto KTO2 on KTO2.KgPeriodeID is Null and
                                                  KTO2.KgKontoID = KTO.GruppeKontoID
                                   inner join KgKonto KTO3 on KTO3.KgPeriodeID = {0} and
                                                  KTO3.KontoNr = KTO2.KontoNr
                    where  KTO.KgPeriodeID = {0}",
                    qryPeriode["KgPeriodeID"]);
                }
                else
                {
                    //letzen Kontenplan kopieren
                    DBUtil.ExecSQL(@"
                        insert   KgKonto
                            (KgPeriodeID,GruppeKontoID,GruppePosition,KontoGruppe,KgKontoKlasseCode,
                             VorsaldoUebertrag,KgKontoartCode,KontoNr,KontoName,Vorsaldo,SortKey)
                        select   {0},GruppeKontoID,GruppePosition,KontoGruppe,KgKontoKlasseCode,
                             VorsaldoUebertrag,KgKontoartCode,KontoNr,KontoName,0,SortKey
                        from     KgKonto
                            where    KgPeriodeID = {1}

                    update KTO
                    set    GruppeKontoID = KTO3.KgKontoID
                    from   KgKonto KTO
                                   inner join KgKonto KTO2 on KTO2.KgPeriodeID = {1} and
                                                  KTO2.KgKontoID = KTO.GruppeKontoID
                                   inner join KgKonto KTO3 on KTO3.KgPeriodeID = {0} and
                                                  KTO3.KontoNr = KTO2.KontoNr
                    where  KTO.KgPeriodeID = {0}",
                    qryPeriode["KgPeriodeID"],
                    qry["KgPeriodeID"]);
                }
                FormController.SendMessage("FrmFall", "Action", "RefreshTree");
                Cursor = Cursors.Default;
            }

            //Name des Verkehrskontos automatisch updaten
            DBUtil.ExecSQL("exec spKgUpdateVerkehrskontoName {0}", qryPeriode["KgPeriodeID"]);

            BuchungenDokumenteUndMT940DatenNeuZuordnen();
        }

        private void qryPeriode_BeforeDelete(object sender, System.EventArgs e)
        {
            if (((int)qryPeriode["KgPeriodeStatusCode"]) == 3)
            {
                KissMsg.ShowInfo("CtlFibuPeriode", "LoeschenNichtMoeglich", "Abgeschlossene Perioden können nicht gelöscht werden !");
                throw new Exception();
            }

            //gibt es noch Buchungen in dieser Periode ?
            SqlQuery qry = DBUtil.OpenSQL(
                "select count(*) Count from KgBuchung where KgPeriodeID = {0}",
                qryPeriode["KgPeriodeID"]);

            if (((int)qry["Count"]) > 0)
            {
                KissMsg.ShowInfo("CtlFibuPeriode", "NochKeineBuchung", "Periode kann nicht gelöscht werden, da noch Buchungen vorhanden sind");
                throw new Exception();
            }

            //Kontenplan löschen
            DBUtil.ExecSQL(
                "delete from KgKonto where KgPeriodeID = {0}",
                qryPeriode["KgPeriodeID"]);
        }

        private void qryPeriode_BeforeInsert(object sender, System.EventArgs e)
        {
            SqlQuery qry = DBUtil.OpenSQL(@"
                select *
                from   BaZahlungsweg
                where  BaPersonID = {0}",
                baPersonID);

            if (qry.Count == 0)
            {
                KissMsg.ShowInfo("Es ist noch keine Zahlinfo in den Basisdaten erfasst (zB. ZKB Kontokorrent)!");
                throw new KissCancelException();
            }
        }

        private void qryPeriode_BeforePost(object sender, System.EventArgs e)
        {
            DBUtil.CheckNotNullField(edtPeriodeVon, lblPeriodeVon.Text);
            DBUtil.CheckNotNullField(edtPeriodeBis, lblPeriodeBis.Text);

            if (DBUtil.IsEmpty(qryPeriode["BaZahlungswegID"]))
            {
                //bei Vermittlungsfällen darf Zahlungsweg leer bleiben
                int Vermittlung = (int)DBUtil.ExecuteScalarSQL("select count(*) from FaLeistung where FaLeistungID = {0} and EroeffnungsgrundCode = 50002", faLeistungID);
                if (Vermittlung == 0)
                    DBUtil.CheckNotNullField(edtBaZahlungsweg, lblBaZahlungsweg.Text);
            }

            // Check DatumBis > DatumVon
            if ((DateTime)edtPeriodeVon.EditValue > (DateTime)edtPeriodeBis.EditValue)
            {
                KissMsg.ShowInfo("CtlKgPeriode", "DatumVonGTDatumBis", "Periode kann nicht gespeichert werden: Sie beginnt nach ihrem Ende...");
                throw new KissCancelException();
            }

            SqlQuery qry;

            if (!chkPeriodenUeberschneidungZulassen.Checked)
            {
                //check Periodenüberschneidung
                qry = DBUtil.OpenSQL(@"
                    select  top 1 1
                    from    KgPeriode PER
                            inner join FaLeistung LEI on LEI.FaLeistungID = PER.FaLeistungID
                    where   LEI.BaPersonID = {0} and
                            KgPeriodeID <> isnull({1},-1) and
                            dbo.fnDatumUeberschneidung({2},{3},PER.PeriodeVon,PER.PeriodeBis) = 1",
                    baPersonID,
                    qryPeriode["KgPeriodeID"],
                    qryPeriode["PeriodeVon"],
                    qryPeriode["PeriodeBis"]);

                if (qry.Count > 0)
                {
                    KissMsg.ShowInfo("Periode kann nicht gespeichert werden, da sie sich mit bestehenden überschneidet");
                    throw new KissCancelException();
                }

                //check bestehende Buchungen

                qry = DBUtil.OpenSQL(@"
                    select top 1 1 from KgBuchung
                    where  KgPeriodeID = {0} and
                           (BuchungsDatum < {1} or
                            BuchungsDatum > {2})",
                    qryPeriode["KgPeriodeID"],
                    qryPeriode["PeriodeVon"],
                    qryPeriode["PeriodeBis"]);

                if (qry.Count > 0)
                {
                    KissMsg.ShowInfo("Periode kann nicht gespeichert werden, da bereits Buchungen ausserhalb des Datumbereichs existieren");
                    throw new KissCancelException();
                }
            }
            else
            {
                //check Periodenüberschneidung mit geschlossener Periode

                qry = DBUtil.OpenSQL(@"
                    select  top 1 1
                    from    KgPeriode PER
                            inner join FaLeistung LEI on LEI.FaLeistungID = PER.FaLeistungID
                    where   LEI.BaPersonID = {0} and
                            KgPeriodeID <> isnull({1},-1) and
                            KgPeriodeStatusCode in (2,3) and
                            dbo.fnDatumUeberschneidung({2},{3},PER.PeriodeVon,PER.PeriodeBis) = 1",
                    baPersonID,
                    qryPeriode["KgPeriodeID"],
                    qryPeriode["PeriodeVon"],
                    qryPeriode["PeriodeBis"]);

                if (qry.Count > 0)
                {
                    KissMsg.ShowInfo("Periode kann nicht gespeichert werden, da sie sich mit inaktiven oder abgeschlossenen Perioden überschneidet");
                    throw new Exception();
                }
            }

            if ((int)qryPeriode["FaLeistungID"] == 0)
            {
                //falls in globaler Maske: jüngste aktive FaLeistung suchen
                qry = DBUtil.OpenSQL(@"
                select  top 1 FaLeistungID
                from    FaLeistung
                where   BaPersonID = {0} and
                            FaProzessCode = 500 and
                            DatumBis is null
                    order by DatumVon desc",
                  baPersonID);

                if (qry.Count == 0)
                {
                    KissMsg.ShowInfo("CtlFibuPeriode", "SpeichernNichtMoeglich2", "Periode kann nicht gespeichert werden, da keine aktive K-Leistung vorhanden ist");
                    throw new Exception();
                }
                else
                {
                    qryPeriode["FaLeistungID"] = qry["FaLeistungID"];
                }
            }

            qryPeriode["KontoZahlverkehr"] = edtBaZahlungsweg.Text;

            SaveRowState = qryPeriode.Row.RowState;
        }

        private void qryPeriode_PositionChanged(object sender, System.EventArgs e)
        {
            int Status = (int)qryPeriode["KgPeriodeStatusCode"];

            qryPeriode.EnableBoundFields(qryPeriode.CanUpdate && Status == 1);
            btnAktiv.Enabled = qryPeriode.CanUpdate && (Status != 3);
            btnAbschluss.Enabled = qryPeriode.CanUpdate && (Status != 3) && DBUtil.UserHasRight("CtlKgPeriode_Abschluss");
            btnSaldiVortragen.Enabled = qryPeriode.CanUpdate;

            FillZahlungswegLookup(baPersonID);
        }

        #endregion
    }
}