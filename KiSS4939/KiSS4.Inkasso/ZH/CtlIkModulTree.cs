#region Header

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.3053
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#endregion

using System;
using System.Windows.Forms;
using KiSS4.Common;
using KiSS4.DB;
using KiSS4.Gui;
using Kiss.Interfaces.UI;

namespace KiSS4.Inkasso.ZH
{
    public class CtlIkModulTree : KiSS4.Common.KissModulTree
    {
        #region Fields

        private DevExpress.XtraBars.BarButtonItem btnDelete;
        private DevExpress.XtraBars.BarButtonItem btnFallZuteilung;
        private DevExpress.XtraBars.BarButtonItem btnNeueAnsprALBV;
        private DevExpress.XtraBars.BarButtonItem btnNeueAnsprKKBB;
        private DevExpress.XtraBars.BarButtonItem btnNeueRueckALBV;
        private DevExpress.XtraBars.BarButtonItem btnNeueRueckKKBB;
        private DevExpress.XtraBars.BarButtonItem btnNeueRueckUebH;
        private DevExpress.XtraBars.BarButtonItem btnNeuerRechtstitel;
        private DevExpress.XtraBars.BarButtonItem btnNeuesInkassoALBV;
        private DevExpress.XtraBars.BarButtonItem btnNeuesInkassoKKBB;
        private DevExpress.XtraBars.BarButtonItem btnNeuesInkassoUebH;
        private DevExpress.XtraBars.BarButtonItem btnZusammenzugDrucken;
        private DevExpress.XtraTreeList.Columns.TreeListColumn colClassName;
        private DevExpress.XtraTreeList.Columns.TreeListColumn colDatum;
        private DevExpress.XtraTreeList.Columns.TreeListColumn colFaLeistungID;
        private DevExpress.XtraTreeList.Columns.TreeListColumn colName;
        private DevExpress.XtraTreeList.Columns.TreeListColumn colProzessCode;
        private System.ComponentModel.IContainer components;
        private IKissView ctlDetail = null;
        private KiSS4.DB.SqlQuery qryPopupMenu;

        #endregion

        #region Constructors

         public CtlIkModulTree(int BaPersonID, System.Windows.Forms.Panel panelDetail)
            : base(BaPersonID, panelDetail, Gui.ModulID.I)
        {
            // This call is required by the Windows Form Designer.
              InitializeComponent();
              this.popup_Tree.LinksPersistInfo.Clear();
              this.popup_Tree.LinksPersistInfo.AddRange(new DevExpress.XtraBars.LinkPersistInfo[] {
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuesInkassoALBV, true),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuesInkassoUebH),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuesInkassoKKBB),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuerRechtstitel, true),
            //
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueAnsprALBV, true),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueAnsprKKBB),
            //
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueRueckALBV, true),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueRueckUebH),
            new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueRueckKKBB),
            //
            new DevExpress.XtraBars.LinkPersistInfo(this.btnDelete, true)
              });
        }

        public CtlIkModulTree()
        {
            this.InitializeComponent();
        }

        #endregion

        #region Windows Form Designer generated code

        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            this.components = new System.ComponentModel.Container();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(CtlIkModulTree));
            this.btnDelete = new DevExpress.XtraBars.BarButtonItem();
            this.btnFallZuteilung = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeueAnsprALBV = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeueAnsprKKBB = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeuerRechtstitel = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeueRueckALBV = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeueRueckKKBB = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeueRueckUebH = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeuesInkassoALBV = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeuesInkassoKKBB = new DevExpress.XtraBars.BarButtonItem();
            this.btnNeuesInkassoUebH = new DevExpress.XtraBars.BarButtonItem();
            this.btnZusammenzugDrucken = new DevExpress.XtraBars.BarButtonItem();
            this.colClassName = new DevExpress.XtraTreeList.Columns.TreeListColumn();
            this.colDatum = new DevExpress.XtraTreeList.Columns.TreeListColumn();
            this.colFaLeistungID = new DevExpress.XtraTreeList.Columns.TreeListColumn();
            this.colName = new DevExpress.XtraTreeList.Columns.TreeListColumn();
            this.colProzessCode = new DevExpress.XtraTreeList.Columns.TreeListColumn();
            this.qryPopupMenu = new KiSS4.DB.SqlQuery(this.components);
            ((System.ComponentModel.ISupportInitialize)(this.kissTree)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryModulTree)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.popup_Tree)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.barManager_Tree)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPopupMenu)).BeginInit();
            this.SuspendLayout();
            //
            // kissTree
            //
            this.kissTree.Appearance.Empty.BackColor = System.Drawing.Color.Transparent;
            this.kissTree.Appearance.Empty.ForeColor = System.Drawing.Color.White;
            this.kissTree.Appearance.Empty.Options.UseBackColor = true;
            this.kissTree.Appearance.Empty.Options.UseForeColor = true;
            this.kissTree.Appearance.EvenRow.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(236)))), ((int)(((byte)(227)))), ((int)(((byte)(215)))));
            this.kissTree.Appearance.EvenRow.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.EvenRow.Options.UseBackColor = true;
            this.kissTree.Appearance.EvenRow.Options.UseForeColor = true;
            this.kissTree.Appearance.FocusedCell.BackColor = System.Drawing.Color.Transparent;
            this.kissTree.Appearance.FocusedCell.ForeColor = System.Drawing.Color.White;
            this.kissTree.Appearance.FocusedCell.Options.UseBackColor = true;
            this.kissTree.Appearance.FocusedCell.Options.UseForeColor = true;
            this.kissTree.Appearance.FocusedRow.ForeColor = System.Drawing.Color.White;
            this.kissTree.Appearance.FocusedRow.Options.UseForeColor = true;
            this.kissTree.Appearance.FooterPanel.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(230)))), ((int)(((byte)(216)))), ((int)(((byte)(174)))));
            this.kissTree.Appearance.FooterPanel.Font = new System.Drawing.Font("Microsoft Sans Serif", 11F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.kissTree.Appearance.FooterPanel.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.FooterPanel.Options.UseBackColor = true;
            this.kissTree.Appearance.FooterPanel.Options.UseFont = true;
            this.kissTree.Appearance.FooterPanel.Options.UseForeColor = true;
            this.kissTree.Appearance.GroupButton.BackColor = System.Drawing.Color.Transparent;
            this.kissTree.Appearance.GroupButton.Font = new System.Drawing.Font("Microsoft Sans Serif", 9F, System.Drawing.FontStyle.Bold);
            this.kissTree.Appearance.GroupButton.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.GroupButton.Options.UseBackColor = true;
            this.kissTree.Appearance.GroupButton.Options.UseFont = true;
            this.kissTree.Appearance.GroupButton.Options.UseForeColor = true;
            this.kissTree.Appearance.GroupFooter.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(240)))), ((int)(((byte)(226)))), ((int)(((byte)(184)))));
            this.kissTree.Appearance.GroupFooter.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.GroupFooter.Options.UseBackColor = true;
            this.kissTree.Appearance.GroupFooter.Options.UseForeColor = true;
            this.kissTree.Appearance.HeaderPanel.BackColor = System.Drawing.Color.Tan;
            this.kissTree.Appearance.HeaderPanel.Font = new System.Drawing.Font("Microsoft Sans Serif", 8F, System.Drawing.FontStyle.Bold);
            this.kissTree.Appearance.HeaderPanel.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.HeaderPanel.Options.UseBackColor = true;
            this.kissTree.Appearance.HeaderPanel.Options.UseFont = true;
            this.kissTree.Appearance.HeaderPanel.Options.UseForeColor = true;
            this.kissTree.Appearance.HideSelectionRow.BackColor = System.Drawing.Color.PowderBlue;
            this.kissTree.Appearance.HideSelectionRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.kissTree.Appearance.HideSelectionRow.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.HideSelectionRow.Options.UseBackColor = true;
            this.kissTree.Appearance.HideSelectionRow.Options.UseFont = true;
            this.kissTree.Appearance.HideSelectionRow.Options.UseForeColor = true;
            this.kissTree.Appearance.HorzLine.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(230)))), ((int)(((byte)(216)))), ((int)(((byte)(174)))));
            this.kissTree.Appearance.HorzLine.ForeColor = System.Drawing.Color.Red;
            this.kissTree.Appearance.HorzLine.Options.UseBackColor = true;
            this.kissTree.Appearance.HorzLine.Options.UseForeColor = true;
            this.kissTree.Appearance.OddRow.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(242)))), ((int)(((byte)(236)))), ((int)(((byte)(215)))));
            this.kissTree.Appearance.OddRow.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.kissTree.Appearance.OddRow.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.OddRow.Options.UseBackColor = true;
            this.kissTree.Appearance.OddRow.Options.UseFont = true;
            this.kissTree.Appearance.OddRow.Options.UseForeColor = true;
            this.kissTree.Appearance.Preview.BackColor = System.Drawing.Color.White;
            this.kissTree.Appearance.Preview.Font = new System.Drawing.Font("Microsoft Sans Serif", 11F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.kissTree.Appearance.Preview.ForeColor = System.Drawing.Color.Maroon;
            this.kissTree.Appearance.Preview.Options.UseBackColor = true;
            this.kissTree.Appearance.Preview.Options.UseFont = true;
            this.kissTree.Appearance.Preview.Options.UseForeColor = true;
            this.kissTree.Appearance.Row.BackColor = System.Drawing.Color.Transparent;
            this.kissTree.Appearance.Row.Font = new System.Drawing.Font("Arial", 12F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Pixel);
            this.kissTree.Appearance.Row.ForeColor = System.Drawing.Color.Black;
            this.kissTree.Appearance.Row.Options.UseBackColor = true;
            this.kissTree.Appearance.Row.Options.UseFont = true;
            this.kissTree.Appearance.Row.Options.UseForeColor = true;
            this.kissTree.Appearance.SelectedRow.ForeColor = System.Drawing.Color.White;
            this.kissTree.Appearance.SelectedRow.Options.UseForeColor = true;
            this.kissTree.Appearance.TreeLine.BackColor = System.Drawing.Color.Gray;
            this.kissTree.Appearance.TreeLine.ForeColor = System.Drawing.Color.Gray;
            this.kissTree.Appearance.TreeLine.Options.UseBackColor = true;
            this.kissTree.Appearance.TreeLine.Options.UseForeColor = true;
            this.kissTree.Appearance.VertLine.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(230)))), ((int)(((byte)(216)))), ((int)(((byte)(174)))));
            this.kissTree.Appearance.VertLine.ForeColor = System.Drawing.Color.FromArgb(((int)(((byte)(198)))), ((int)(((byte)(166)))), ((int)(((byte)(70)))));
            this.kissTree.Appearance.VertLine.Options.UseBackColor = true;
            this.kissTree.Appearance.VertLine.Options.UseForeColor = true;
            this.kissTree.Appearance.VertLine.Options.UseTextOptions = true;
            this.kissTree.Appearance.VertLine.TextOptions.HAlignment = DevExpress.Utils.HorzAlignment.Near;
            this.kissTree.Columns.AddRange(new DevExpress.XtraTreeList.Columns.TreeListColumn[] {
                        this.colName,
                        this.colDatum,
                        this.colClassName,
                        this.colFaLeistungID,
                        this.colProzessCode});
            this.kissTree.OptionsBehavior.AutoSelectAllInEditor = false;
            this.kissTree.OptionsBehavior.CloseEditorOnLostFocus = false;
            this.kissTree.OptionsBehavior.Editable = false;
            this.kissTree.OptionsBehavior.KeepSelectedOnClick = false;
            this.kissTree.OptionsBehavior.MoveOnEdit = false;
            this.kissTree.OptionsBehavior.ShowToolTips = false;
            this.kissTree.OptionsBehavior.SmartMouseHover = false;
            this.kissTree.OptionsMenu.EnableColumnMenu = false;
            this.kissTree.OptionsMenu.EnableFooterMenu = false;
            this.kissTree.OptionsSelection.EnableAppearanceFocusedCell = false;
            this.kissTree.OptionsView.AutoWidth = false;
            this.kissTree.OptionsView.EnableAppearanceEvenRow = true;
            this.kissTree.OptionsView.EnableAppearanceOddRow = true;
            this.kissTree.OptionsView.ShowIndicator = false;
            this.kissTree.OptionsView.ShowVertLines = false;
            this.kissTree.Size = new System.Drawing.Size(265, 618);
            this.kissTree.Styles.AddReplace("PressedColumn", new DevExpress.Utils.ViewStyle("PressedColumn", "TreeList", new System.Drawing.Font("Microsoft Sans Serif", 8F, System.Drawing.FontStyle.Bold), "HeaderPanel", ((DevExpress.Utils.StyleOptions)(((DevExpress.Utils.StyleOptions.StyleEnabled | DevExpress.Utils.StyleOptions.UseBackColor)
                                | DevExpress.Utils.StyleOptions.UseForeColor))), true, false, false, DevExpress.Utils.HorzAlignment.Near, DevExpress.Utils.VertAlignment.Center, null, System.Drawing.Color.FromArgb(((int)(((byte)(247)))), ((int)(((byte)(239)))), ((int)(((byte)(222))))), System.Drawing.Color.FromArgb(((int)(((byte)(255)))), ((int)(((byte)(255)))), ((int)(((byte)(255)))))));
            //
            // qryModulTree
            //
            this.qryModulTree.SelectStatement = "EXECUTE dbo.spXGetModulTree {0}, {1}, {2}, {3}, {4}";
            //
            // popup_Tree
            //
            this.popup_Tree.LinksPersistInfo.AddRange(new DevExpress.XtraBars.LinkPersistInfo[] {
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuerRechtstitel),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnFallZugriff),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnFallInfo),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeuesInkassoALBV),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueRueckALBV),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueAnsprKKBB),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueAnsprALBV),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnDelete),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnNeueRueckKKBB),
                        new DevExpress.XtraBars.LinkPersistInfo(this.btnZusammenzugDrucken)});
            this.popup_Tree.BeforePopup += new System.EventHandler(this.popup_Tree_BeforePopup);
            //
            // barManager_Tree
            //
            this.barManager_Tree.Items.AddRange(new DevExpress.XtraBars.BarItem[] {
                        this.btnFallZuteilung,
                        this.btnNeuesInkassoALBV,
                        this.btnNeuesInkassoUebH,
                        this.btnNeuesInkassoKKBB,
                        this.btnNeueAnsprALBV,
                        this.btnNeueAnsprKKBB,
                        this.btnNeuerRechtstitel,
                        this.btnNeueRueckALBV,
                        this.btnNeueRueckUebH,
                        this.btnNeueRueckKKBB,
                        this.btnDelete,
                        this.btnZusammenzugDrucken});
            //
            // btnFallZugriff
            //
            this.btnFallZugriff.CategoryGuid = new System.Guid("f96a77cc-41a0-4295-8f5a-5c2410a21ef7");
            //
            // btnFallInfo
            //
            this.btnFallInfo.CategoryGuid = new System.Guid("f96a77cc-41a0-4295-8f5a-5c2410a21ef7");
            //
            // btnDelete
            //
            this.btnDelete.Caption = "Löschen";
            this.btnDelete.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnDelete.GroupIndex = 3;
            this.btnDelete.Id = 12;
            this.btnDelete.ImageIndex = 4;
            this.btnDelete.Name = "btnDelete";
            this.btnDelete.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnDelete_ItemClick);
            //
            // btnFallZuteilung
            //
            this.btnFallZuteilung.Caption = "Fallzuteilung";
            this.btnFallZuteilung.Glyph = ((System.Drawing.Image)(resources.GetObject("btnFallZuteilung.Glyph")));
            this.btnFallZuteilung.Id = 13;
            this.btnFallZuteilung.Name = "btnFallZuteilung";
            this.btnFallZuteilung.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnFallZuteilung_ItemClick);
            //
            // btnNeueAnsprALBV
            //
            this.btnNeueAnsprALBV.Caption = "Neue Anspruchsberechnung ALBV/ÜbH";
            this.btnNeueAnsprALBV.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnNeueAnsprALBV.GroupIndex = 2;
            this.btnNeueAnsprALBV.Id = 11;
            this.btnNeueAnsprALBV.ImageIndex = 1401;
            this.btnNeueAnsprALBV.Name = "btnNeueAnsprALBV";
            this.btnNeueAnsprALBV.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeueAnsprALBV_ItemClick);
            //
            // btnNeueAnsprKKBB
            //
            this.btnNeueAnsprKKBB.Caption = "Neue Anspruchsberechnung KKBB";
            this.btnNeueAnsprKKBB.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnNeueAnsprKKBB.GroupIndex = 2;
            this.btnNeueAnsprKKBB.Id = 8;
            this.btnNeueAnsprKKBB.ImageIndex = 1401;
            this.btnNeueAnsprKKBB.Name = "btnNeueAnsprKKBB";
            this.btnNeueAnsprKKBB.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeueAnsprKKBB_ItemClick);
            //
            // btnNeuerRechtstitel
            //
            this.btnNeuerRechtstitel.Caption = "Neuer Rechtstitel";
            this.btnNeuerRechtstitel.Id = 15;
            this.btnNeuerRechtstitel.ImageIndex = 1;
            this.btnNeuerRechtstitel.Name = "btnNeuerRechtstitel";
            this.btnNeuerRechtstitel.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeuerRechtstitel_ItemClick);
            //
            // btnNeueRueckALBV
            //
            this.btnNeueRueckALBV.Caption = "Neue Rückforderung ALBV";
            this.btnNeueRueckALBV.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnNeueRueckALBV.GroupIndex = 2;
            this.btnNeueRueckALBV.Id = 5;
            this.btnNeueRueckALBV.ImageIndex = 1401;
            this.btnNeueRueckALBV.Name = "btnNeueRueckALBV";
            this.btnNeueRueckALBV.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeueRueckALBV_ItemClick);
            //
            // btnNeueRueckKKBB
            //
            this.btnNeueRueckKKBB.Caption = "Neue Rückforderung KKBB";
            this.btnNeueRueckKKBB.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnNeueRueckKKBB.GroupIndex = 2;
            this.btnNeueRueckKKBB.Id = 9;
            this.btnNeueRueckKKBB.ImageIndex = 1401;
            this.btnNeueRueckKKBB.Name = "btnNeueRueckKKBB";
            this.btnNeueRueckKKBB.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeueRueckKKBB_ItemClick);
            //
            // btnNeueRueckUebH
            //
            this.btnNeueRueckUebH.Caption = "Neue Rückforderung ÜbH";
            this.btnNeueRueckUebH.Id = 14;
            this.btnNeueRueckUebH.ImageIndex = 1401;
            this.btnNeueRueckUebH.Name = "btnNeueRueckUebH";
            this.btnNeueRueckUebH.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeueRueckUebH_ItemClick);
            //
            // btnNeuesInkassoALBV
            //
            this.btnNeuesInkassoALBV.Caption = "Neues Alimenteninkasso ALBV+ALV";
            this.btnNeuesInkassoALBV.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnNeuesInkassoALBV.GroupIndex = 2;
            this.btnNeuesInkassoALBV.Id = 4;
            this.btnNeuesInkassoALBV.ImageIndex = 1401;
            this.btnNeuesInkassoALBV.Name = "btnNeuesInkassoALBV";
            this.btnNeuesInkassoALBV.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeuesInkassoALBV_ItemClick);
            //
            // btnNeuesInkassoKKBB
            //
            this.btnNeuesInkassoKKBB.Caption = "Neues KKBB";
            this.btnNeuesInkassoKKBB.Id = 18;
            this.btnNeuesInkassoKKBB.ImageIndex = 1401;
            this.btnNeuesInkassoKKBB.Name = "btnNeuesInkassoKKBB";
            this.btnNeuesInkassoKKBB.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeuesInkassoKKBB_ItemClick);
            //
            // btnNeuesInkassoUebH
            //
            this.btnNeuesInkassoUebH.Caption = "Neue Überbrückungshilfe ÜbH";
            this.btnNeuesInkassoUebH.Id = 17;
            this.btnNeuesInkassoUebH.ImageIndex = 1401;
            this.btnNeuesInkassoUebH.Name = "btnNeuesInkassoUebH";
            this.btnNeuesInkassoUebH.ItemClick += new DevExpress.XtraBars.ItemClickEventHandler(this.btnNeuesInkassoUebH_ItemClick);
            //
            // btnZusammenzugDrucken
            //
            this.btnZusammenzugDrucken.Caption = "Zusammenzug drucken";
            this.btnZusammenzugDrucken.CategoryGuid = new System.Guid("92fbb9f1-c7fb-43f6-8806-b5fa8cad8229");
            this.btnZusammenzugDrucken.GroupIndex = 2;
            this.btnZusammenzugDrucken.Id = 7;
            this.btnZusammenzugDrucken.ImageIndex = 24;
            this.btnZusammenzugDrucken.Name = "btnZusammenzugDrucken";
            //
            // colClassName
            //
            this.colClassName.Caption = "Typ";
            this.colClassName.FieldName = "ClassName";
            this.colClassName.Name = "colClassName";
            this.colClassName.OptionsColumn.AllowSort = false;
            //
            // colDatum
            //
            this.colDatum.Caption = "ab";
            this.colDatum.FieldName = "Datum";
            this.colDatum.Name = "colDatum";
            this.colDatum.OptionsColumn.AllowSort = false;
            this.colDatum.VisibleIndex = 1;
            //
            // colFaLeistungID
            //
            this.colFaLeistungID.FieldName = "FaLeistungID";
            this.colFaLeistungID.Name = "colFaLeistungID";
            this.colFaLeistungID.OptionsColumn.AllowSort = false;
            //
            // colName
            //
            this.colName.Caption = "Alimentwesen";
            this.colName.FieldName = "Name";
            this.colName.Name = "colName";
            this.colName.OptionsColumn.AllowSort = false;
            this.colName.VisibleIndex = 0;
            this.colName.Width = 200;
            //
            // colProzessCode
            //
            this.colProzessCode.Caption = "ProzessCode";
            this.colProzessCode.FieldName = "ProzessCode";
            this.colProzessCode.Name = "colProzessCode";
            this.colProzessCode.OptionsColumn.AllowSort = false;
            //
            // qryPopupMenu
            //
            this.qryPopupMenu.HostControl = this;
            this.qryPopupMenu.SelectStatement = resources.GetString("qryPopupMenu.SelectStatement");
            //
            // CtlIkModulTree
            //
            this.Name = "CtlIkModulTree";
            this.Size = new System.Drawing.Size(265, 618);
            this.Load += new System.EventHandler(this.CtlIkModulTree_Load);
            ((System.ComponentModel.ISupportInitialize)(this.kissTree)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryModulTree)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.popup_Tree)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.barManager_Tree)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.qryPopupMenu)).EndInit();
            this.ResumeLayout(false);
        }

        #endregion

        #region Dispose

        /// <summary>
        /// Clean up any resources being used.
        /// </summary>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                if ((components != null))
                {
                    components.Dispose();
                }
            }
            base.Dispose(disposing);
        }

        #endregion

        #region Public Methods

        // Letzte Bearbeitung:
        // 16.04.2008 : sozheo : neu
        // ----------------------------------------------------------------
        public void DisplayTree(string treeID)
        {
            FormController.SendMessage( "FrmFall", "Action", "RefreshTree" );

              //ev. Neupositionierung auf neuen Eintrag
              if (treeID != string.Empty)
              {
            DevExpress.XtraTreeList.Nodes.TreeListNode node = DBUtil.FindNodeByValue(kissTree.Nodes,treeID,"ID");
            if (node != null)
            {
              kissTree.FocusedNode = node;
              node.Expanded = true;
              kissTree_AfterFocusNode(null, new DevExpress.XtraTreeList.NodeEventArgs(node));
            }
              }
        }

        #endregion

        #region Protected Methods

        protected override void kissTree_AfterFocusNode(object sender, DevExpress.XtraTreeList.NodeEventArgs e)
        {
            // Letzte Bearbeitung:
            // 14.08.2007 : sozheo : TODOs hinzugefügt
            // 28.08.2007 : sozksc : Rechtstitel
            // 29.08.2007 : sozheo : Rechtstitel, Anpassungen für Register Gläubiger + Forderungen
            // 12.09.2007 : sozheo : Anpassungen für Monatszahlen
            // 07.11.2007 : sozheo : Anpassungen für Anzeige nur Kinder bei einmaligen Beträgen
            // 23.01.2008 : sozheo : ProzessCode eingebaut
            // 25.01.2008 : sozheo : FallID als Parameter eingebaut bei Kontoauszug
            // 30.01.2008 : sozheo : Rechtstitel_UEBH und Rechtstitel_KKBB eingebaut
            // 03.04.2008 : sozheo : Sperren, wenn Leistung-Datum-Bis definiert ist
            // 10.02.2009 : sozheo : Neue Maske Interne Verrechnung
            // 10.04.2009 : sozheo : Korrekturen für ALIM5 Monatszahlen
            // ---------------------------------------------------------------------------------------------------------

            // handle empty node
            if( e==null || e.Node==null )
            {
                return;
            }

            Cursor currentCursor = Cursor.Current;
            try
            {
              Cursor.Current = Cursors.WaitCursor;
              string className = e.Node.GetValue("ClassName") as string;
              string TreeID = Utils.ConvertToString(e.Node.GetValue("ID"));
              if( className != null )
              {
                ctlDetail = null;
                object baPersonID         = e.Node.GetValue("BaPersonID");
                object faLeistungID       = e.Node.GetValue( this.colFaLeistungID );
                object faFallID           = e.Node.GetValue("FaFallID");
                object faProzessCode      = e.Node.GetValue("ProzessCode");
                object LeistgGeschlossen  = e.Node.GetValue("LeistungGeschlossen");
                string name               = e.Node.GetValue( this.colName ) as string;
                System.Drawing.Image icon = this.GetIcon(e);

                int intPerson = Utils.ConvertToInt(baPersonID);
                int intFall = Utils.ConvertToInt(faFallID);
                int intLeistg = Utils.ConvertToInt(faLeistungID);
                int intProzessCode = Utils.ConvertToInt(faProzessCode);
                int intRechtstitel = Utils.ConvertToInt(e.Node.GetValue("RechtstitelID"));
                bool LeistungGeschlossen = (LeistgGeschlossen is bool) ? (bool)LeistgGeschlossen : true;

                System.Type type = AssemblyLoader.GetType( className );
                if( type != null )
                {
                  switch( className )
                  {
                    case "CtlIkLeistungAlbv":
                    case "CtlIkLeistungUebhKkbb":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type, icon, name, intLeistg, intProzessCode);
                      break;
                    case "CtlIkInterneVerrechnung":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "Init", intFall, intLeistg, intProzessCode, LeistungGeschlossen);
                      break;
                    case "CtlAmAnspruchsberechnung":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance(type, icon,
                        intFall, intPerson, intLeistg, intProzessCode, LeistungGeschlossen);
                      break;
                    case "CtlIkRechtstitel":
                    case "CtlIkRechtstitelUebh":
                    case "CtlIkRechtstitelKkbb":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance(
                        type, intLeistg, intFall, icon, false, intRechtstitel, intProzessCode, LeistungGeschlossen);
                      break;
                    case "CtlIkMonatszahlen":
                      bool NeueMZ = Utils.ConvertToBool(e.Node.GetValue("NeueMZ"), false);
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance(
                        type, intLeistg, intFall, icon, intRechtstitel, intPerson, intProzessCode, LeistungGeschlossen, NeueMZ);
                      break;
                    case "CtlIkMonatszahlenEinmalig":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "InitLeistung", name, icon,
                        intFall, intLeistg, intProzessCode, true, false, LeistungGeschlossen);
                      break;
                    case "CtlIkRatenplan":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "Init", intLeistg, intFall, LeistungGeschlossen);
                      break;
                    case "CtlIkRechtstitelVerrechnung":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "InitFromATree", intLeistg, LeistungGeschlossen);
                      break;
                    case "CtlIkForderungen":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "Init", name, icon, intFall, intLeistg, intProzessCode, LeistungGeschlossen);
                      break;
                    case "CtlIkKontoauszug":
                      ctlDetail = (KissUserControl)AssemblyLoader.CreateInstance( type );
                      AssemblyLoader.InvokeMethode( ctlDetail, "Init", name, icon, intFall, intLeistg, intPerson, TreeID, intProzessCode, LeistungGeschlossen);
                      break;
                    default:
                      ctlDetail = _showDetail.GetDetailControl( type, true);
                      if( ctlDetail != null )
                      {
                        try
                        {
                          AssemblyLoader.InvokeMethode( ctlDetail, "Init", name, this.GetIcon(e) );
                        }
                        catch{}
                      }
                      break;
                  }

                  if( ctlDetail != null )
                  {
                    ctlDetail.Name = name;
                    if (ctlDetail is KissUserControl)
                    {
                        this.ApplyEditMaskToSqlQuery(((KissUserControl)ctlDetail).ActiveSQLQuery);
                    }
                    this.ShowDetail(ctlDetail, true);
                  }
                }
              }
            }
            catch (Exception f)
            {
              KissMsg.ShowError("CtlAiModulTreeDynaPrepare", "EintragAnzeigenNichtMoeglich", "Der gewünschte Eintrag kann nicht angezeigt werden", f);
            }
            finally
            {
              Cursor.Current = currentCursor;
            }
        }

        #endregion

        #region Private Methods

        private void CtlIkModulTree_Load(object sender, System.EventArgs e)
        {
            this.FillTree();

            //expand top 3 levels
            foreach (DevExpress.XtraTreeList.Nodes.TreeListNode node1 in this.kissTree.Nodes)
            {
              node1.Expanded = true;
              foreach (DevExpress.XtraTreeList.Nodes.TreeListNode node2 in node1.Nodes)
              {
                node2.Expanded = true;
                foreach (DevExpress.XtraTreeList.Nodes.TreeListNode node3 in node2.Nodes)
                  node3.Expanded = true;
              }
            }

            if (this.kissTree.Nodes.Count > 0) this.kissTree.FocusedNode = this.kissTree.Nodes[0];
        }

        // Letzte Bearbeitung:
        // 22.01.2008 : sozheo : Unnötiges ausgeklammert
        // 14.02.2008 : sozheo : Bei Rückforderungen kein Rechtstitel erstellen
        // 16.04.2008 : sozheo : Korrekturen FaLeistung.SchuldnerBaPersonID
        // 08.05.2008 : sozheo : Neu Auswahl Leistungsträger bei Anspruchsberechnung
        // --------------------------------------------------------------------
        private void InsertLeistungsart(int prozessCode)
        {
            // neues Inkasso nur möglich, falls bereits eine Fallführung existiert
            int faFallID = -1;
            int SchuldnerBaPersonID = 0;

            // Maskenname holen
            string MaskenName = "CtlIkLeistungAlbv";
            if (prozessCode == 406 || prozessCode == 407) MaskenName = "CtlIkLeistungUebhKkbb";

            // FallID holen
            object obj = DBUtil.ExecuteScalarSQL("SELECT FaFallID FROM FaLeistung WHERE BaPersonID = {0} AND FaProzessCode = 201 AND DatumBis IS NULL", this.BaPersonID);

				if (obj == null)
				{
					KissMsg.ShowInfo("Es existiert keine aktive Fallführung Alimentenstelle oder der Fall ist abgeschlossen.");
					return;
				}

				int.TryParse(obj.ToString(), out faFallID);

            this.kissTree.SaveState();

            // Fallperson soll nirgends mehr verwendet werden:
            SchuldnerBaPersonID = 0; // this.DmgPersonID;

            // Schuldner wählen:
            KissLookupDialog dlg = new KissLookupDialog();
            if (prozessCode == 406 || prozessCode == 407) // Inkassi UeBH und KKBB
                dlg.Text = "Gesuchsteller/in des Inkasso wählen";
            else if (prozessCode == 402 || prozessCode == 404) // Anspruchsberechnungen ALBV/UeBH und KKBB
                dlg.Text = "Vertreter/in der Anspruchsberechnung wählen";
            else
                dlg.Text = "Schuldner des Inkasso wählen";

            string sql = string.Format(@"
                SELECT
                  BaPersonID$ = PRS.BaPersonID,
                  Person = PRS.Name + IsNull(', ' + PRS.Vorname,''),
                  Geschlecht = dbo.fnLOVtext('BaGeschlecht', PRS.GeschlechtCode),
                  FT = Convert(bit, case when {1} = PRS.BaPersonID then 1 else 0 end),
                  Geburtsdatum = Convert(varchar, PRS.Geburtsdatum, 104),
                  [Alter] = dbo.fnGetAge(PRS.Geburtsdatum, GetDate()),
                  [Relation zum Fallträger] = IsNull(dbo.fnBaRelationClient({1}, PRS.BaPersonID, GetDate()), '[Fallträger/in]'),
                  [Anzahl Inkassi] = (
                    Select count(*) from dbo.FaLeistung L with(readuncommitted)
                    where L.FaFallID = {0} and L.BaPersonID = PRS.BaPersonID and L.FaProzessCode in (405,406,407)),
                  [Anzahl Rückf.] = (
                    Select count(*) from dbo.FaLeistung L with(readuncommitted)
                    where L.FaFallID = {0} and L.BaPersonID = PRS.BaPersonID and L.FaProzessCode in (408,409,410))
                FROM FaFallPerson FPR
                LEFT JOIN BaPerson PRS ON PRS.BaPersonID = FPR.BaPersonID
                WHERE FPR.FaFallID = {0}
                ORDER BY
                  CASE WHEN {1} = PRS.BaPersonID THEN 0 ELSE 1 END, [Alter] DESC",
                faFallID,
                this.BaPersonID
            );
            if (!dlg.SearchData(sql, null, true))
                return;
            SchuldnerBaPersonID = Utils.ConvertToInt(dlg["BaPersonID$"]);
            if (SchuldnerBaPersonID == 0)
            {
                KissMsg.ShowInfo("Der Leistungsträger darf nicht leer sein. Der Vorgang wurde abgebrochen.");
                return;
            }

            SqlQuery qry = DBUtil.OpenSQL(@"
                DECLARE @Res INT
                EXEC @Res = dbo.spFaLeistung_Insert {0}, {1}, {2}, {3}, {4}
                SELECT RES = @Res",
                this.BaPersonID,
                prozessCode,
                Session.User.UserID,
                Session.User["OrgUnitID"],
                SchuldnerBaPersonID
            );
            int Res = Utils.ConvertToInt(qry["Res"]);

            string Msg = "";
            if (Res <= 0) Msg = "Unbekannter Fehler in spFaLeistung_Insert.";
            switch (Res)
            {
                case -1 : Msg = "Falsche Parameter."; break;
                case -2 : Msg = "Es existiert keine aktive Fallführung Alimentenstelle oder der Fall ist abgeschlossen."; break;
                case -3 : Msg = "Fehler beim Holen der PSCD-Gegenstandsnummer."; break;
                case -4 : Msg = "Unbekannter Fehler beim Einfügen einer Leistung."; break;
            }

            if (Msg == "")
            {
                // kein Fehler
                DisplayTree(MaskenName + Res.ToString());
            }
            else
            {
                // Fehlermeldung anzeigen
                KissMsg.ShowInfo(Msg);
            }

            /*
              if (prozessCode == 407)  // für Inkasso KKBB
            int.TryParse(
              DBUtil.ExecuteScalarSQL(@"
                INSERT INTO FaLeistung (FaFallID, ModulID, FaProzessCode, BaPersonID, UserID, DatumVon, EroeffnungsGrundCode, SchuldnerBaPersonID)
                VALUES ({0}, 4, {1}, {2}, {3}, GETDATE(), 40503, {2})
                Select SCOPE_IDENTITY()",
                //faFallID, prozessCode, this.DmgPersonID, Session.User.UserID
                faFallID, prozessCode, SchuldnerBaPersonID, Session.User.UserID, SchuldnerBaPersonID
              ).ToString(), out LeiID
            );
              else if (prozessCode == 406 || prozessCode == 402 || prozessCode == 404)  // für Inkasso UEBH, Anspruchsberechnungen ALBV/UeBH und KKBB
            int.TryParse(
              DBUtil.ExecuteScalarSQL(@"
                INSERT INTO FaLeistung (FaFallID, ModulID, FaProzessCode, BaPersonID, UserID, DatumVon, SchuldnerBaPersonID)
                VALUES ({0}, 4, {1}, {2}, {3}, GETDATE(), {2})
                Select SCOPE_IDENTITY()",
                //faFallID, prozessCode, this.DmgPersonID, Session.User.UserID
                faFallID, prozessCode, SchuldnerBaPersonID, Session.User.UserID, SchuldnerBaPersonID
              ).ToString(), out LeiID
            );
              else
            int.TryParse(
              DBUtil.ExecuteScalarSQL(@"
                INSERT INTO FaLeistung (FaFallID, ModulID, FaProzessCode, BaPersonID, UserID, DatumVon, SchuldnerBaPersonID)
                VALUES ({0}, 4, {1}, {2}, {3}, GETDATE(), {4})
                Select SCOPE_IDENTITY()",
                faFallID, prozessCode, SchuldnerBaPersonID, Session.User.UserID, SchuldnerBaPersonID
              ).ToString(), out LeiID
            );

              if (LeiID <= 0)
              {
            KissMsg.ShowInfo("CltIkModulTree", "LeistungNichtMoeglich", "Beim Einfügen der Leistung ist ein Fehler aufgetreten.");
            return;
              }

              if (prozessCode == 405 || prozessCode == 406 || prozessCode == 407)  // Inkassi ALBV, UeBH, KKBB
              {
            DBUtil.ExecuteScalarSQL(@"INSERT INTO IkRechtstitel(FaLeistungID, Mahnlauf) VALUES ({0}, 0)", LeiID);
              }

              //FormController.SendMessage( "FrmFall", "Action", "RefreshTree" );
              DisplayTree(MaskenName + LeiID.ToString());  $
              */
        }

        // Letzte Bearbeitung
        // 05.09.2007 : sozheo : neu
        // 12.10.2007 : sozheo : Sichtbarkeit der Buttons neu/löschen korrigiert
        // 22.01.2008 : sozheo : neue Menus einbauen
        // ----------------------------------------------------------------------------------------
        private void SetPopupMenuVisibility(DevExpress.XtraBars.BarButtonItem btn, bool IsVisible)
        {
            if (IsVisible)
                btn.Visibility = DevExpress.XtraBars.BarItemVisibility.Always;
            else
                btn.Visibility = DevExpress.XtraBars.BarItemVisibility.Never;
        }

        private void btnDelete_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // 24.09.2008 : sozheo : Neue Meldung, wenn Rechtstitel in Anspruchsberechnung existiert
            // -------------------------------------------------------------------------------------

            if (kissTree.FocusedNode == null) return;

            int CaseID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("FaFallID"));
            int LeistgID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("FaLeistungID"));
            string ClassName = Utils.ConvertToString(kissTree.FocusedNode.GetValue("ClassName"));
            int RechtsTitID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("RechtstitelID"));

            if (ClassName == "CtlIkRechtstitel" || ClassName == "CtlIkRechtstitelUebh" || ClassName == "CtlIkRechtstitelKkbb")
            {
                SqlQuery qryRT;
                string RTName = (ClassName == "CtlIkRechtstitel" || ClassName == "CtlIkRechtstitelUebh") ?
                  "Dieser Rechtstitel" :
                  "Diese Bedingung";

                string AndNam = (ClassName == "CtlIkRechtstitel" || ClassName == "CtlIkRechtstitelUebh") ?
                  "einen anderen Rechtstitel" :
                  "eine andere Bedingung";

                string DelQst = (ClassName == "CtlIkRechtstitel" || ClassName == "CtlIkRechtstitelUebh") ?
                  "Soll dieser Rechtstitel wirklich gelöscht werden?" :
                  "Soll diese Bedingung wirklich gelöscht werden?";

                // Kontrolle, ob es noch Gläubiger gibt:
                qryRT = DBUtil.OpenSQL(@"
                    select Anzahl = count(*) from dbo.IkGlaeubiger 
                    where IkRechtstitelID = {0}",
                    RechtsTitID
                );
                if (Utils.ConvertToInt(qryRT["Anzahl"]) > 0)
                {
                    KissMsg.ShowInfo(string.Format(
                        "Im Rechtstitel '{0}' sind noch Gläubiger erfasst.\r\n" +
                        "Entfernen Sie zuerst die Gläubiger.",
                        RTName
                    ));
                    return;
                }

                // Es ist möglich, dass der Rechtstitel bei den Anspruchsberechnung bereits verwendet wurde.
                // Führt zu ForeignKey Verletzung, deshalb neue Meldung:
                // Kontrolle, ob noch in der Anspruchsberechnung verwendet:
                qryRT = DBUtil.OpenSQL(@"
                    select Anzahl = count(*) from dbo.AmAbKind 
                    where IkRechtstitelID = {0}", 
                    RechtsTitID
                );
                int AnzRT = Utils.ConvertToInt(qryRT["Anzahl"]);
                if (AnzRT > 0)
                {
                    KissMsg.ShowInfo(
                        RTName + " wird als Zuordnung noch bei der Anspruchsberechnung verwendet.\r\n" +
                        "Löschen Sie zuerst die Zuordnung bei der Anspruchsberechnung,\r\n" +
                        "indem Sie " + AndNam + " wählen oder die Anspruchsberechnung löschen.\r\n" +
                        "Falls die Anspruchsberechnung bereits gesperrt ist, muss zuerst die Sperrung aufgehoben werden."
                    );
                    return;
                }

                // Erst Löschen, wenn keine Monatszahlen vorhanden sind.
                qryRT = DBUtil.OpenSQL(@"
                    select Anzahl = count(*) from dbo.IkRechtstitelPosition P
                    where P.IkRechtstitelID = {0}",
                    RechtsTitID
                );
                AnzRT = Utils.ConvertToInt(qryRT["Anzahl"]);
                if (AnzRT > 0)
                {
                    KissMsg.ShowInfo(string.Format(
                        "'{0}' wird als Zuordnung noch bei den Monatszahlen verwendet.",
                        RTName
                    ));
                    return;
                }

                // Erst Löschen, wenn keine Monatszahlen vorhanden sind.
                qryRT = DBUtil.OpenSQL(@"
                    select Anzahl = count(*) from dbo.IkPosition P
                    where P.IkRechtstitelID = {0}",
                    RechtsTitID
                );
                AnzRT = Utils.ConvertToInt(qryRT["Anzahl"]);
                if (AnzRT > 0)
                {
                    KissMsg.ShowInfo(string.Format(
                        "'{0}' wird als Zuordnung noch bei den Monatszahlen verwendet.",
                        RTName
                    ));
                    return;
                }

                // Jetzt darf gelöscht werden ...
                if (KissMsg.ShowQuestion(DelQst))
                {
                    DBUtil.ExecSQL(@"DELETE FROM dbo.IkRechtstitel WHERE IkRechtstitelID = {0}", RechtsTitID);
                }
            }
            else if (ClassName == "CtlAmAnspruchsberechnung")
            {
                if (KissMsg.ShowQuestion("CtlIkModulTree", "AnspruchLoeschenAlle",
                    "Sollen alle {0} gelöscht werden?", 0, 0, true, 
                    Utils.ConvertToString(kissTree.FocusedNode.GetValue("Name"))
                ))
                {
                    DBUtil.ExecSQL(@"DELETE FROM dbo.FaLeistung WHERE FaLeistungID = {0}", LeistgID);
                }
            }
            else if (ClassName == "CtlIkLeistungAlbv" || ClassName == "CtlIkLeistungUebhKkbb")
            {
                if (KissMsg.ShowQuestion("CtlIkModulTree", "InkassoLoeschen", "Soll dieses Inkasso gelöscht werden?", true))
                {
                  //DBUtil.ExecSQL(@"DELETE FROM FaLeistung WHERE FaLeistungID = {0}", LeistgID);
                  ((IKissDataNavigator)DetailControl).DeleteData();
                }
            }
            else
            {
                KissMsg.ShowInfo("Noch nicht implementiert!");
            }

            FormController.SendMessage("FrmFall", "Action", "RefreshTree");
        }

        private void btnFallZuteilung_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            FormController.ShowDialogOnMain("DlgFallZuteilung", this.BaPersonID);
        }

        private void btnNeueAnsprALBV_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(402);
        }

        private void btnNeueAnsprKKBB_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(404);
        }

        private void btnNeueRueckALBV_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(408);
        }

        private void btnNeueRueckKKBB_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(410);
        }

        private void btnNeueRueckUebH_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(409);
        }

        private bool KontrolleLeistungen(int faLeistgID, int perCode, DateTime neuesDatum, string perName)
        {
            // Kinderzulagen sind immer ab ersten eines Monats
            // TODO : Achtung : Falls der alte RT für ein Kind weiterläuft?
            DateTime neuesDatumVon = (perCode == 3) ? Utils.firstDayOfMonth(neuesDatum) : neuesDatum;
            SqlQuery qryForderg = DBUtil.OpenSQL(@"
                select DatumAnpassenAb, Betrag, DatumGueltigBis from dbo.IkForderung
                where FaLeistungID = {0}
                  and IkForderungPeriodischCode = {1}
                  order by DatumAnpassenAb desc",
                faLeistgID, perCode
            );

            if (qryForderg.Count > 0)
            {
                if (Utils.ConvertToDateTime(qryForderg["DatumAnpassenAb"]) > neuesDatum)
                {
                    KissMsg.ShowInfo(string.Format(
                        "Es existieren noch {0} mit dem Gültig-Ab-Datum {1},\r\n" +
                        "welches nach dem Abschluss des Rechtstitels liegt ({2}).",
                        perName, 
                        Utils.ConvertToDateTime(qryForderg["DatumAnpassenAb"]).ToString("dd.MM.yyyy"),
                        neuesDatum.ToString("dd.MM.yyyy")
                    ));
                    return false;
                }

                if (Utils.ConvertToDecimal(qryForderg["Betrag"]) > 0 && 
                    DBUtil.IsEmpty(qryForderg["DatumGueltigBis"]) 
                )
                {
                    KissMsg.ShowInfo(string.Format(
                        "Es existieren noch {0} mit leerem Gültig-Bis-Datum.",
                        perName 
                    ));
                    return false;
                }
                else if (
                    Utils.ConvertToDecimal(qryForderg["Betrag"]) > 0 &&
                    Utils.ConvertToDateTime(qryForderg["DatumGueltigBis"]) > neuesDatum
                )
                {
                    KissMsg.ShowInfo(string.Format(
                        "Es existieren noch {0} mit dem Gültig-Bis-Datum {1},\r\n" +
                        "welches nach dem Abschluss des Rechtstitels liegt ({2}).",
                        perName,
                        Utils.ConvertToDateTime(qryForderg["DatumGueltigBis"]).ToString("dd.MM.yyyy"),
                        neuesDatum.ToString("dd.MM.yyyy")
                    ));
                    return false;
                }
            }
            return true;
        }

        private void btnNeuerRechtstitel_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // 09.03.2009 : sozheo : Text ÜbH korrigiert
            // ----------------------------------------------------------------
            int ProzessCode = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("ProzessCode"));
            int faLeistungID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("FaLeistungID"));
            DateTime neuesDatumVon = DateTime.Today;

            string Bezeichnung = "";
            switch (ProzessCode)
            {
                case 405: Bezeichnung = "Rechtstitel ALBV, " + DateTime.Today.ToString("dd.MM.yyyy"); break;
                case 406: Bezeichnung = "Rechtstitel ÜbH, " + DateTime.Today.ToString("dd.MM.yyyy"); break;
                case 407: Bezeichnung = "Bedingung KKBB, " + DateTime.Today.ToString("dd.MM.yyyy"); break;
            }

            // Ein Rechtstitel kann im Laufe eines Monates beendet werden (auch rückwirkend) 
            // und ein neuer Rechtstitel irgendwann später, frühestens aber am nächsten Tag (nach gültig bis). 
            // Beim Eröffnen eines neuen RT wird kontrolliert, ob der alte RT abgeschlossen ist 
            // (das Startdatum des neuen RT kann höchstens der nachfolgende Tag des Abschlusses des alten RT sein). 
            
            // Kontrolliern, ob alle RT abgeschlossen sind
            /*
            if (ProzessCode == 405 || ProzessCode == 406)
            {
                qryRTAlt = DBUtil.OpenSQL(@"
                    select top 1 Bezeichnung from dbo.IkRechtstitel
                    where FaLeistungID = {0} and IkRechtstitelGueltigBis is NULL",
                    faLeistungID);

                if (qryRTAlt.Count > 0)
                {
                    string RTName = Utils.ConvertToString(qryRTAlt["Bezeichnung"]);
                    KissMsg.ShowInfo(string.Format(
                        "Der Rechtstitel '{0}' ist noch nicht abgeschlossen.\r\n" +
                        "Es kann kein neuer Rechtstitel erfasst werden, wenn es noch offene Rechtstitel gibt.",
                        RTName
                    ));
                    return;
                }

                // Neustes Datum holen
                qryRTAlt = DBUtil.OpenSQL(@"
                    select top 1 IkRechtstitelID, IkRechtstitelGueltigBis from dbo.IkRechtstitel
                    where FaLeistungID = {0} order by IkRechtstitelGueltigVon desc",
                    faLeistungID
                );

                if (!DBUtil.IsEmpty(qryRTAlt["IkRechtstitelID"]))
                {
                    // es gibt Rechtstitel
                    if (DBUtil.IsEmpty(qryRTAlt["IkRechtstitelGueltigBis"]))
                    {
                        // Sicherheitskontrolle, tritt nur ein, wenn 2 User gleichzeitig bearbeiten
                        KissMsg.ShowInfo("Programmfehler: Modultree.btnNeuerRechtstitel_ItemClick(): Datum bis nicht gefunden.");
                        return;
                    }
                    neuesDatumVon = Utils.ConvertToDateTime(qryRTAlt["IkRechtstitelGueltigBis"], DateTime.Today);
                    neuesDatumVon.AddDays(1);

                    // Kontrolle, ob es Forderungen gibt
                    // 1 = Kinderalimente
                    if (!KontrolleLeistungen(faLeistungID, 1, neuesDatumVon, "Kinderalimente")) return;
                    // 2 = Erwachsenenalimente
                    if (!KontrolleLeistungen(faLeistungID, 2, neuesDatumVon, "Erwachsenenalimente")) return;
                    // 3 = Kinderzulagen
                    if (!KontrolleLeistungen(faLeistungID, 3, neuesDatumVon, "Kinderzulagen")) return;
                }
            }
             * */

            // Einfügen neuer RT in DB
            DBUtil.ExecuteScalarSQL(@"
                INSERT INTO dbo.IkRechtstitel(Bezeichnung, FaLeistungID, Mahnlauf, IkRechtstitelGueltigVon)
                VALUES ({0}, {1}, 0, {2})",
                Bezeichnung, faLeistungID, DateTime.Today
            );

            FormController.SendMessage( "FrmFall", "Action", "RefreshTree" );
        }

        private void btnNeuesInkassoALBV_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(405);
        }

        private void btnNeuesInkassoKKBB_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(407);
        }

        private void btnNeuesInkassoUebH_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            // Letzte Bearbeitung:
            // 04.04.2008 : sozheo : neu
            // ----------------------------------------------------------------
            this.InsertLeistungsart(406);
        }

        private void popup_Tree_BeforePopup(object sender, EventArgs e)
        {
            bool vis = false;
            int CaseID = 0;
            int LeistgID = 0;
            string ClassName = string.Empty;
            int RechtsTitID = 0;
            int ProzessCode = 0;

            if (kissTree.FocusedNode != null)
            {
                CaseID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("FaFallID"));
                LeistgID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("FaLeistungID"));
                ProzessCode = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("ProzessCode"));
                ClassName = Utils.ConvertToString(kissTree.FocusedNode.GetValue("ClassName"));
                RechtsTitID = Utils.ConvertToInt(kissTree.FocusedNode.GetValue("RechtstitelID"));
                btnDelete.Caption = kissTree.FocusedNode.GetDisplayText("Name") + " löschen";
            }

            qryPopupMenu.Fill(CaseID, LeistgID, RechtsTitID, Session.User.UserID);

            bool CaseIsClosed = (Utils.ConvertToInt(qryPopupMenu["CaseIsClosed"]) == 1);
            bool ServiceIsClosed = (Utils.ConvertToInt(qryPopupMenu["ServiceIsClosed"]) == 1);
            bool IsAlimInkasso = (Utils.ConvertToInt(qryPopupMenu["IstAlimInkasso"]) == 1);

            bool HatRecht_Anspruchsberechnung = (bool)qryPopupMenu["HatRecht_Anpruchsberechnung"];
            bool HatRecht_Inkasso = (bool)qryPopupMenu["HatRecht_Inkasso"];
            bool HatRecht_Rechtstitel = (bool)qryPopupMenu["HatRecht_Rechtstitel"];

            //bool HatRecht_Anspruchsberechnung = (Utils.ConvertToInt(qryPopupMenu["HatRecht_Anpruchsberechnung"]) == 1);
            //bool HatRecht_Inkasso = (Utils.ConvertToInt(qryPopupMenu["HatRecht_Inkasso"]) == 1);
            //bool HatRecht_Rechtstitel = (Utils.ConvertToInt(qryPopupMenu["HatRecht_Rechtstitel"]) == 1);

            //bool HatRecht_Anspruchsberechnung = true;
            //bool HatRecht_Inkasso = true;
            //bool HatRecht_Rechtstitel = true;

            // btnNeuerRechtstitel: Menu für neuen Rechtstitel:
            vis = (
                !CaseIsClosed &&
                LeistgID>0 &&
                HatRecht_Inkasso  &&
                HatRecht_Rechtstitel  && (
                  ClassName == "CtlIkLeistungAlbv" || (
                    ClassName == "CtlIkLeistungUebhKkbb" && (ProzessCode != 407 || Utils.ConvertToInt(qryPopupMenu["AnzahlRechtstitel"]) == 0)
                  ) ||
                  ClassName == "CtlIkGlaeubiger" ||
                  ClassName == "CtlIkRechtstitel" ||
                  ClassName == "CtlIkRechtstitelUebh" || (
                    ClassName == "CtlIkRechtstitelKkbb" && Utils.ConvertToInt(qryPopupMenu["AnzahlRechtstitel"]) == 0
                  ) ||
                  ClassName == "CtlIkMonatszahlen" || (
                    ClassName == "CtlIkLeistung" && IsAlimInkasso
                  )
                )
            );
            if (Utils.ConvertToInt(qryPopupMenu["IstKKBB"]) == 1)
                btnNeuerRechtstitel.Caption = "Neue Bedingung";
            else
                btnNeuerRechtstitel.Caption = "Neuer Rechtstitel";
            SetPopupMenuVisibility(btnNeuerRechtstitel, vis);

            // btnNeueAnsprALBV: Menu für neue Anspruchsberechnung ALBV:
            vis = (!CaseIsClosed &&
                HatRecht_Anspruchsberechnung &&
                Utils.ConvertToInt(qryPopupMenu["AnzahlAnspruch_ALBV_UeBH"]) == 0
            );
            SetPopupMenuVisibility(btnNeueAnsprALBV, vis);

            // btnNeueAnsprKKBB: Menu für neue Anspruchsberechnung KKBB:
            vis = (!CaseIsClosed &&
                HatRecht_Anspruchsberechnung &&
                Utils.ConvertToInt(qryPopupMenu["AnzahlAnspruchKKBB"]) == 0
            );
            SetPopupMenuVisibility(btnNeueAnsprKKBB, vis);

            // btnNeuesInkassoALBV: Menu für neues Alimentinkasso:
            vis = (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeuesInkassoALBV, vis);

            // btnNeuesInkassoUebH: Menu für neues Alimentinkasso:
            vis = (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeuesInkassoUebH, vis);

            // btnNeuesInkassoKKBB: Menu für neues Alimentinkasso:
            vis = (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeuesInkassoKKBB, vis);

            // btnNeueRueckALBV: Menu für neue Rückforderung ALBV:
            vis = (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeueRueckALBV, vis);

            // btnNeueRueckUebH: Menu für neue Rückforderung UebH:
            vis = (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeueRueckUebH, vis);

            // btnNeueRueckKKBB: Menu für neue Rückforderung KKBB:
            vis =  (!CaseIsClosed && HatRecht_Inkasso);
            SetPopupMenuVisibility(btnNeueRueckKKBB, vis);

            // btnDelete: Menu Löschen für alle Einträge:
            SetPopupMenuVisibility(btnDelete,
                !ClassName.Equals("") &&
                !CaseIsClosed &&
                !ServiceIsClosed &&
                LeistgID>0 &&
                (
                  (
                    (
                      ClassName.Equals("CtlIkRechtstitel") ||
                      ClassName.Equals("CtlIkRechtstitelUebh") ||
                      ClassName.Equals("CtlIkRechtstitelKkbb")
                    ) &&
                    HatRecht_Inkasso  &&
                    HatRecht_Rechtstitel
                  )	|| (
                    ClassName.Equals("CtlAmAnspruchsberechnung") &&
                    HatRecht_Anspruchsberechnung &&
                    Utils.ConvertToInt(qryPopupMenu["AnzahlAMAnspruch"]) == 0
                  ) ||
                  (
                    ClassName.Equals("CtlIkLeistungAlbv") ||
                    ClassName.Equals("CtlIkLeistungUebhKkbb")
                  ) &&
                  HatRecht_Inkasso &&
                  Utils.ConvertToInt(qryPopupMenu["AnzahlRechtstitel"]) == 0 &&
                  Utils.ConvertToInt(qryPopupMenu["AnzahlMonatszahlen"]) == 0 &&
                  Utils.ConvertToInt(qryPopupMenu["AnzahlVKonto"]) == 0 &&
                  Utils.ConvertToInt(qryPopupMenu["AnzahlForderung"]) == 0 &&
                  Utils.ConvertToInt(qryPopupMenu["AnzahlGlaeubiger"]) == 0
                )
            );

            // Fallzugriff/Fallinfo/Fallzuteilung:
            btnFallZugriff.Visibility = DevExpress.XtraBars.BarItemVisibility.Never;
            btnFallInfo.Visibility = DevExpress.XtraBars.BarItemVisibility.Never;
            btnFallZuteilung.Visibility = DevExpress.XtraBars.BarItemVisibility.Always;
        }

        #endregion
    }
}