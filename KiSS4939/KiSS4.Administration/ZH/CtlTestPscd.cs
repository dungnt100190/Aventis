//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:2.0.50727.832
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Text;
using System.Windows.Forms;
using KiSS4.DB;
using KiSS4.Gui;
using KiSS4.Messages;

namespace KiSS4.Administration
{
    public class CtlTestPscd : KiSS4.Gui.KissUserControl
    {
        private KiSS4.Gui.KissButton btnSendAlim;
        private KiSS4.Gui.KissButton btnSendWh;
        private KiSS4.Gui.KissTextEdit edtBruttoIDs;
        private KiSS4.Gui.KissTextEdit edtIDs;
        private KiSS4.Gui.KissTextEdit edtNettoIDs;
        private KiSS4.Gui.KissLabel kissLabel1;
        private KiSS4.Gui.KissLabel kissLabel2;
        private KiSS4.DB.SqlQuery sqlQuery1;
        private System.ComponentModel.IContainer components;
        private KissLabel kissLabel3;
        private KissLabel lblStornoNettoIDs;
        private KissTextEdit edtStornoNettoIDs;
        private KissTextEdit edtStornoBruttoIDs;
        private KissButton btnStorno;
        private CheckBox chbTest;
        private KissDateEdit edtValuta;
        private KiSS4.DB.SqlQuery sqlQuery2;

        public CtlTestPscd()
        {
            this.InitializeComponent();
            edtValuta.EditValue = DateTime.Today;
        }

        #region Designer generated code
        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InitializeComponent()
        {
            this.components = new System.ComponentModel.Container();
            this.btnSendAlim = new KiSS4.Gui.KissButton();
            this.btnSendWh = new KiSS4.Gui.KissButton();
            this.edtBruttoIDs = new KiSS4.Gui.KissTextEdit();
            this.edtIDs = new KiSS4.Gui.KissTextEdit();
            this.edtNettoIDs = new KiSS4.Gui.KissTextEdit();
            this.kissLabel1 = new KiSS4.Gui.KissLabel();
            this.kissLabel2 = new KiSS4.Gui.KissLabel();
            this.sqlQuery1 = new KiSS4.DB.SqlQuery(this.components);
            this.sqlQuery2 = new KiSS4.DB.SqlQuery(this.components);
            this.kissLabel3 = new KiSS4.Gui.KissLabel();
            this.lblStornoNettoIDs = new KiSS4.Gui.KissLabel();
            this.edtStornoNettoIDs = new KiSS4.Gui.KissTextEdit();
            this.edtStornoBruttoIDs = new KiSS4.Gui.KissTextEdit();
            this.btnStorno = new KiSS4.Gui.KissButton();
            this.chbTest = new System.Windows.Forms.CheckBox();
            this.edtValuta = new KiSS4.Gui.KissDateEdit();
            ((System.ComponentModel.ISupportInitialize)(this.edtBruttoIDs.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtIDs.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtNettoIDs.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel1)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.sqlQuery1)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.sqlQuery2)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblStornoNettoIDs)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtStornoNettoIDs.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtStornoBruttoIDs.Properties)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtValuta.Properties)).BeginInit();
            this.SuspendLayout();
            // 
            // btnSendAlim
            // 
            this.btnSendAlim.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnSendAlim.Location = new System.Drawing.Point(468, 23);
            this.btnSendAlim.Name = "btnSendAlim";
            this.btnSendAlim.Size = new System.Drawing.Size(133, 24);
            this.btnSendAlim.TabIndex = 1;
            this.btnSendAlim.Text = "Alim-Belege senden";
            this.btnSendAlim.UseCompatibleTextRendering = true;
            this.btnSendAlim.UseVisualStyleBackColor = false;
            this.btnSendAlim.Click += new System.EventHandler(this.btnSendAlim_Click);
            // 
            // btnSendWh
            // 
            this.btnSendWh.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnSendWh.Location = new System.Drawing.Point(550, 141);
            this.btnSendWh.Name = "btnSendWh";
            this.btnSendWh.Size = new System.Drawing.Size(133, 24);
            this.btnSendWh.TabIndex = 1;
            this.btnSendWh.Text = "Wh-Belege senden";
            this.btnSendWh.UseCompatibleTextRendering = true;
            this.btnSendWh.UseVisualStyleBackColor = false;
            this.btnSendWh.Click += new System.EventHandler(this.btnSendWh_Click);
            // 
            // edtBruttoIDs
            // 
            this.edtBruttoIDs.Location = new System.Drawing.Point(100, 157);
            this.edtBruttoIDs.Name = "edtBruttoIDs";
            this.edtBruttoIDs.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtBruttoIDs.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtBruttoIDs.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtBruttoIDs.Properties.Appearance.Options.UseBackColor = true;
            this.edtBruttoIDs.Properties.Appearance.Options.UseBorderColor = true;
            this.edtBruttoIDs.Properties.Appearance.Options.UseFont = true;
            this.edtBruttoIDs.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtBruttoIDs.Size = new System.Drawing.Size(444, 24);
            this.edtBruttoIDs.TabIndex = 2;
            // 
            // edtIDs
            // 
            this.edtIDs.Location = new System.Drawing.Point(18, 23);
            this.edtIDs.Name = "edtIDs";
            this.edtIDs.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtIDs.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtIDs.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtIDs.Properties.Appearance.Options.UseBackColor = true;
            this.edtIDs.Properties.Appearance.Options.UseBorderColor = true;
            this.edtIDs.Properties.Appearance.Options.UseFont = true;
            this.edtIDs.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtIDs.Size = new System.Drawing.Size(444, 24);
            this.edtIDs.TabIndex = 2;
            // 
            // edtNettoIDs
            // 
            this.edtNettoIDs.Location = new System.Drawing.Point(100, 127);
            this.edtNettoIDs.Name = "edtNettoIDs";
            this.edtNettoIDs.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtNettoIDs.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtNettoIDs.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtNettoIDs.Properties.Appearance.Options.UseBackColor = true;
            this.edtNettoIDs.Properties.Appearance.Options.UseBorderColor = true;
            this.edtNettoIDs.Properties.Appearance.Options.UseFont = true;
            this.edtNettoIDs.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtNettoIDs.Size = new System.Drawing.Size(444, 24);
            this.edtNettoIDs.TabIndex = 2;
            // 
            // kissLabel1
            // 
            this.kissLabel1.Location = new System.Drawing.Point(18, 127);
            this.kissLabel1.Name = "kissLabel1";
            this.kissLabel1.Size = new System.Drawing.Size(64, 24);
            this.kissLabel1.TabIndex = 3;
            this.kissLabel1.Text = "Netto-IDs";
            this.kissLabel1.UseCompatibleTextRendering = true;
            // 
            // kissLabel2
            // 
            this.kissLabel2.Location = new System.Drawing.Point(18, 157);
            this.kissLabel2.Name = "kissLabel2";
            this.kissLabel2.Size = new System.Drawing.Size(64, 24);
            this.kissLabel2.TabIndex = 3;
            this.kissLabel2.Text = "Brutto-IDs";
            this.kissLabel2.UseCompatibleTextRendering = true;
            // 
            // sqlQuery1
            // 
            this.sqlQuery1.HostControl = this;
            // 
            // sqlQuery2
            // 
            this.sqlQuery2.HostControl = this;
            // 
            // kissLabel3
            // 
            this.kissLabel3.Location = new System.Drawing.Point(18, 256);
            this.kissLabel3.Name = "kissLabel3";
            this.kissLabel3.Size = new System.Drawing.Size(64, 24);
            this.kissLabel3.TabIndex = 7;
            this.kissLabel3.Text = "Brutto-IDs";
            this.kissLabel3.UseCompatibleTextRendering = true;
            // 
            // lblStornoNettoIDs
            // 
            this.lblStornoNettoIDs.Location = new System.Drawing.Point(18, 226);
            this.lblStornoNettoIDs.Name = "lblStornoNettoIDs";
            this.lblStornoNettoIDs.Size = new System.Drawing.Size(64, 24);
            this.lblStornoNettoIDs.TabIndex = 8;
            this.lblStornoNettoIDs.Text = "Netto-IDs";
            this.lblStornoNettoIDs.UseCompatibleTextRendering = true;
            // 
            // edtStornoNettoIDs
            // 
            this.edtStornoNettoIDs.Location = new System.Drawing.Point(100, 226);
            this.edtStornoNettoIDs.Name = "edtStornoNettoIDs";
            this.edtStornoNettoIDs.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtStornoNettoIDs.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtStornoNettoIDs.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtStornoNettoIDs.Properties.Appearance.Options.UseBackColor = true;
            this.edtStornoNettoIDs.Properties.Appearance.Options.UseBorderColor = true;
            this.edtStornoNettoIDs.Properties.Appearance.Options.UseFont = true;
            this.edtStornoNettoIDs.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtStornoNettoIDs.Size = new System.Drawing.Size(444, 24);
            this.edtStornoNettoIDs.TabIndex = 6;
            // 
            // edtStornoBruttoIDs
            // 
            this.edtStornoBruttoIDs.Location = new System.Drawing.Point(100, 256);
            this.edtStornoBruttoIDs.Name = "edtStornoBruttoIDs";
            this.edtStornoBruttoIDs.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtStornoBruttoIDs.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtStornoBruttoIDs.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtStornoBruttoIDs.Properties.Appearance.Options.UseBackColor = true;
            this.edtStornoBruttoIDs.Properties.Appearance.Options.UseBorderColor = true;
            this.edtStornoBruttoIDs.Properties.Appearance.Options.UseFont = true;
            this.edtStornoBruttoIDs.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtStornoBruttoIDs.Size = new System.Drawing.Size(444, 24);
            this.edtStornoBruttoIDs.TabIndex = 5;
            // 
            // btnStorno
            // 
            this.btnStorno.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
            this.btnStorno.Location = new System.Drawing.Point(603, 240);
            this.btnStorno.Name = "btnStorno";
            this.btnStorno.Size = new System.Drawing.Size(133, 24);
            this.btnStorno.TabIndex = 4;
            this.btnStorno.Text = "Stornieren";
            this.btnStorno.UseCompatibleTextRendering = true;
            this.btnStorno.UseVisualStyleBackColor = false;
            this.btnStorno.Click += new System.EventHandler(this.btnStorno_Click);
            // 
            // chbTest
            // 
            this.chbTest.AutoSize = true;
            this.chbTest.Location = new System.Drawing.Point(550, 261);
            this.chbTest.Name = "chbTest";
            this.chbTest.Size = new System.Drawing.Size(47, 17);
            this.chbTest.TabIndex = 9;
            this.chbTest.Text = "Test";
            this.chbTest.UseVisualStyleBackColor = true;
            // 
            // edtValuta
            // 
            this.edtValuta.EditValue = null;
            this.edtValuta.Location = new System.Drawing.Point(564, 171);
            this.edtValuta.Name = "edtValuta";
            this.edtValuta.Properties.AllowNullInput = DevExpress.Utils.DefaultBoolean.False;
            this.edtValuta.Properties.Appearance.BackColor = System.Drawing.Color.AliceBlue;
            this.edtValuta.Properties.Appearance.BorderColor = System.Drawing.Color.Linen;
            this.edtValuta.Properties.Appearance.Font = new System.Drawing.Font("Arial", 13F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Pixel);
            this.edtValuta.Properties.Appearance.Options.UseBackColor = true;
            this.edtValuta.Properties.Appearance.Options.UseBorderColor = true;
            this.edtValuta.Properties.Appearance.Options.UseFont = true;
            this.edtValuta.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.HotFlat;
            this.edtValuta.Properties.Buttons.AddRange(new DevExpress.XtraEditors.Controls.EditorButton[] {
            new DevExpress.XtraEditors.Controls.EditorButton(DevExpress.XtraEditors.Controls.ButtonPredefines.Combo)});
            this.edtValuta.Properties.ButtonsStyle = DevExpress.XtraEditors.Controls.BorderStyles.UltraFlat;
            this.edtValuta.Properties.ShowToday = false;
            this.edtValuta.Size = new System.Drawing.Size(100, 24);
            this.edtValuta.TabIndex = 10;
            // 
            // CtlTestPscd
            // 
            this.Controls.Add(this.edtValuta);
            this.Controls.Add(this.chbTest);
            this.Controls.Add(this.kissLabel3);
            this.Controls.Add(this.lblStornoNettoIDs);
            this.Controls.Add(this.edtStornoNettoIDs);
            this.Controls.Add(this.edtStornoBruttoIDs);
            this.Controls.Add(this.btnStorno);
            this.Controls.Add(this.kissLabel2);
            this.Controls.Add(this.kissLabel1);
            this.Controls.Add(this.edtNettoIDs);
            this.Controls.Add(this.edtIDs);
            this.Controls.Add(this.edtBruttoIDs);
            this.Controls.Add(this.btnSendWh);
            this.Controls.Add(this.btnSendAlim);
            this.Name = "CtlTestPscd";
            this.Size = new System.Drawing.Size(948, 515);
            ((System.ComponentModel.ISupportInitialize)(this.edtBruttoIDs.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtIDs.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtNettoIDs.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel1)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel2)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.sqlQuery1)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.sqlQuery2)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.kissLabel3)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.lblStornoNettoIDs)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtStornoNettoIDs.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtStornoBruttoIDs.Properties)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.edtValuta.Properties)).EndInit();
            this.ResumeLayout(false);
            this.PerformLayout();

        }
        #endregion

        /// <summary>
        /// Clean up any resources being used.
        /// </summary>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                if ((components != null))
                {
                    components.Dispose();
                }
            }
            base.Dispose(disposing);
        }

        private void btnSendAlim_Click(object sender, System.EventArgs e)
        {

            // Begin Rule
            // ControlName: btnSendAlim, RuleType: Event_Click
            try
            {
                string idstrings = edtIDs.Text;
                int[] ids = (new List<string>(idstrings.Split(','))).ConvertAll<int>(Convert.ToInt32).ToArray();

                KiSS4.FAMOZ.PSCDServices.PSCDInterface.SubmitAlimBuchungsstoff(ids);
                KissMsg.ShowInfo(string.Format("Belege wurden erfolgreich an PSCD übermittelt"));
            }
            catch (Exception ex)
            {
                KissMsg.ShowError("Verbindung zum Server konnte nicht hergestellt werden", "Verbindung fehlgeschlagen", "Verbindung zum Server konnte nicht hergestellt werden", ex);
            }
            // End Rule
        }

        private void btnSendWh_Click(object sender, System.EventArgs e)
        {
            DlgProgressLog.Show(
                "Sende Brutto/Netto-Belege",
                new ProgressEventHandler(StartSendWh),
                null,
                Session.MainForm);
        }

        private void StartSendWh()
        {
            try
            {
                string nettoIdStrings = edtNettoIDs.Text;
                List<int> nettoIds = new List<int>();

                if (!string.IsNullOrEmpty(nettoIdStrings))
                    nettoIds = (new List<string>(nettoIdStrings.Split(','))).ConvertAll<int>(Convert.ToInt32);

                string bruttoIdStrings = edtBruttoIDs.Text;
                List<int> bruttoIds = new List<int>();

                if (!string.IsNullOrEmpty(bruttoIdStrings))
                    bruttoIds = (new List<string>(bruttoIdStrings.Split(','))).ConvertAll<int>(Convert.ToInt32);

                DlgProgressLog.AddLine(string.Format("Übermittle Netto-Beleg: {0} von {1}", 0, nettoIds.Count));
                int count = 0;
                foreach (int id in nettoIds)
                {
                    count++;

                    try
                    {
                        KiSS4.FAMOZ.PSCDServices.PSCDInterface.SubmitWhBuchungsstoff(new int[] { id }, null, edtValuta.DateTime);
                        DlgProgressLog.UpdateLastLine(string.Format("Übermittle Netto-Beleg: {0} von {1}", count, nettoIds.Count));
                    }
                    catch (Exception ex)
                    {
                        DlgProgressLog.AddError(string.Format("Netto-Beleg {0} meldet Übermittlungsfehler: {1}", id, ex.ToString()));
                        if (count < nettoIds.Count)
                            DlgProgressLog.AddLine(string.Format("Übermittle Netto-Beleg: {0} von {1}", count, nettoIds.Count));
                    }
                }

                DlgProgressLog.AddLine(string.Format("Übermittle Brutto-Beleg: {0} von {1}", 0, bruttoIds.Count));
                count = 0;
                foreach (int id in bruttoIds)
                {
                    count++;

                    try
                    {
                        KiSS4.FAMOZ.PSCDServices.PSCDInterface.SubmitWhBuchungsstoff(null, new int[] { id }, edtValuta.DateTime);
                        DlgProgressLog.UpdateLastLine(string.Format("Übermittle Brutto-Beleg: {0} von {1}", count, bruttoIds.Count));
                    }
                    catch (Exception ex)
                    {
                        DlgProgressLog.AddError(string.Format("Brutto-Beleg {0} meldet Übermittlungsfehler: {1}", id, ex.ToString()));
                        if (count < bruttoIds.Count)
                            DlgProgressLog.AddLine(string.Format("Übermittle Brutto-Beleg: {0} von {1}", count, bruttoIds.Count));
                    }
                }
            }
            catch (Exception ex)
            {
                try
                {
                    DlgProgressLog.AddError(string.Format("Problem beim Aufbereiten der Daten: {0}", ex));
                }
                catch (Exception ex2)
                {
                    StringBuilder sb = new StringBuilder(ex.ToString());
                    sb.Append(ex2.ToString());

                    KissMsg.ShowError(string.Format("Problem beim Aufbereiten der Daten: {0}", sb));
                }
            }
            finally
            {
                DlgProgressLog.EndProgress();
                if (DlgProgressLog.HasErrors)
                    DlgProgressLog.ShowTopMost();
                else
                    DlgProgressLog.CloseDialog();
            }
        }

        private void btnStorno_Click(object sender, EventArgs e)
        {
            try
            {
                string nettoIdStrings = edtStornoNettoIDs.Text;
                int[] nettoIds = null;
                if (!string.IsNullOrEmpty(nettoIdStrings))
                {
                    nettoIds = (new List<string>(nettoIdStrings.Split(','))).ConvertAll<int>(Convert.ToInt32).ToArray();
                    KiSS4.FAMOZ.PSCDServices.PSCDInterface.StornoNettoBelege(nettoIds, DateTime.Today);
                    KissMsg.ShowInfo(string.Format("Nettostorno erfolgreich"));
                }

                string bruttoIdStrings = edtStornoBruttoIDs.Text;
                int[] bruttoIds = null;
                if (!string.IsNullOrEmpty(bruttoIdStrings))
                {
                    bruttoIds = (new List<string>(bruttoIdStrings.Split(','))).ConvertAll<int>(Convert.ToInt32).ToArray();
                    KiSS4.FAMOZ.PSCDServices.PSCDInterface.StornoBruttoBelege(bruttoIds, chbTest.Checked, DateTime.Today);
                    KissMsg.ShowInfo(string.Format("Bruttostorno erfolgreich"));
                }
            }
            catch (Exception ex)
            {
                KissMsg.ShowError("Fehler beim Übermitteln", "Verbindung fehlgeschlagen", "Fehler beim Übermitteln", ex);
            }
        }
    }
}